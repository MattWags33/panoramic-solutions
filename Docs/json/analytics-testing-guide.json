{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-05T00:00:00Z",
  "type": "CHECKLIST",
  "metadata": {
    "project": "Panoramic Solutions - PPM Tool Analytics",
    "maintainer": "Parker Gawne",
    "purpose": "Step-by-step testing and verification guide"
  },
  "pre_deployment_checklist": {
    "database_setup": [
      {
        "step": 1,
        "task": "Verify migration applied successfully",
        "command": "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = 'analytics' AND table_name = 'visitor_sessions');",
        "expected": "true",
        "status": "COMPLETED"
      },
      {
        "step": 2,
        "task": "Verify all RPC functions exist",
        "command": "SELECT routine_name FROM information_schema.routines WHERE routine_schema = 'public' AND routine_name LIKE 'track_%';",
        "expected": "track_page_view, track_criteria_ranking, track_guided_ranking_answer, track_tool_click, track_tool_impression, track_report_sent, get_session_data",
        "status": "COMPLETED"
      },
      {
        "step": 3,
        "task": "Verify indexes created",
        "command": "SELECT tablename, indexname FROM pg_indexes WHERE schemaname = 'analytics';",
        "expected": "Multiple indexes on visitor_sessions, events, tool_clicks, tool_impressions",
        "status": "COMPLETED"
      },
      {
        "step": 4,
        "task": "Test RPC function directly",
        "command": "SELECT track_page_view('test-session-123', '/ppm-tool', NULL, NULL, 'Test User Agent', NULL, NULL, NULL);",
        "expected": "{\"success\": true, \"session_id\": \"test-session-123\"}",
        "cleanup": "DELETE FROM analytics.visitor_sessions WHERE session_id = 'test-session-123';"
      }
    ],
    "frontend_compilation": [
      {
        "step": 1,
        "task": "Verify no TypeScript errors",
        "command": "npm run build",
        "expected": "Build succeeds with no errors"
      },
      {
        "step": 2,
        "task": "Verify analytics.ts exports correctly",
        "test": "Import { analytics } from '@/lib/analytics' in any component",
        "expected": "No import errors, IDE autocomplete works"
      },
      {
        "step": 3,
        "task": "Start dev server",
        "command": "npm run dev",
        "expected": "Server starts on http://localhost:3000"
      }
    ]
  },
  "end_to_end_testing": {
    "test_1_page_view_tracking": {
      "description": "Verify session creation on initial page load",
      "steps": [
        {
          "step": 1,
          "action": "Open browser console (F12)",
          "purpose": "Watch for console logs"
        },
        {
          "step": 2,
          "action": "Navigate to http://localhost:3000/ppm-tool",
          "expected_console": "ðŸ“Š Analytics initialized: { sessionId: '...', timestamp: '...' }"
        },
        {
          "step": 3,
          "action": "Open browser DevTools â†’ Application â†’ Local Storage",
          "verification": "Key 'analytics_session_id' exists with UUID value"
        },
        {
          "step": 4,
          "action": "Go to Supabase dashboard â†’ Table Editor â†’ analytics.visitor_sessions",
          "sql": "SELECT * FROM analytics.visitor_sessions ORDER BY created_at DESC LIMIT 1;",
          "verification": {
            "session_id": "Matches localStorage value",
            "total_page_views": "1",
            "is_active": "false (no meaningful action yet)",
            "user_agent": "Contains your browser info",
            "criteria_rankings": "{}",
            "guided_ranking_answers": "{}",
            "tools_clicked": "{}"
          }
        },
        {
          "step": 5,
          "action": "Check analytics.events table",
          "sql": "SELECT * FROM analytics.events WHERE session_id = 'YOUR_SESSION_ID' ORDER BY created_at DESC;",
          "verification": {
            "event_type": "page_view",
            "page_path": "/ppm-tool",
            "event_data": "Contains user_agent and utm params"
          }
        }
      ],
      "pass_criteria": "Session created, event logged, localStorage set"
    },
    "test_2_criteria_slider_tracking": {
      "description": "Verify manual ranking tracking when sliders move",
      "steps": [
        {
          "step": 1,
          "action": "On PPM tool page, move 'Ease of Use' slider to 5",
          "expected_console": "No errors (tracking is silent)"
        },
        {
          "step": 2,
          "action": "Move 'Scalability' slider to 2",
          "purpose": "Create multiple ranking changes"
        },
        {
          "step": 3,
          "action": "Move 'Integration' slider to 4",
          "purpose": "Third data point"
        },
        {
          "step": 4,
          "action": "Check Supabase â†’ analytics.visitor_sessions",
          "sql": "SELECT session_id, criteria_rankings, has_manual_ranking FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID';",
          "verification": {
            "criteria_rankings": "{\"ease_of_use\": 5, \"scalability\": 2, \"integration\": 4}",
            "has_manual_ranking": "true",
            "is_active": "true"
          }
        },
        {
          "step": 5,
          "action": "Check analytics.events",
          "sql": "SELECT event_type, event_data FROM analytics.events WHERE session_id = 'YOUR_SESSION_ID' AND event_type = 'criteria_ranking' ORDER BY created_at DESC;",
          "verification": "3 rows with correct criteria names and scores"
        }
      ],
      "pass_criteria": "criteria_rankings JSONB updated in real-time, has_manual_ranking = true"
    },
    "test_3_guided_ranking_tracking": {
      "description": "Verify guided ranking questionnaire tracking",
      "steps": [
        {
          "step": 1,
          "action": "Click 'Guided Rankings' button",
          "expected": "Modal opens with questionnaire"
        },
        {
          "step": 2,
          "action": "Answer Q1 (project volume) â†’ Select '100-499 projects per year' (value: 4)",
          "then": "Click Next"
        },
        {
          "step": 3,
          "action": "Answer Q2 (tasks per project) â†’ Select '100-499 tasks per project' (value: 3)",
          "then": "Click Next"
        },
        {
          "step": 4,
          "action": "Continue answering all questions through Q12",
          "note": "For multi-select (Q11, Q12), select 2-3 options"
        },
        {
          "step": 5,
          "action": "Click 'Submit' or 'Finish'",
          "expected": "Modal closes, sliders animate to new values"
        },
        {
          "step": 6,
          "action": "Check Supabase â†’ analytics.visitor_sessions",
          "sql": "SELECT guided_ranking_answers, firmographics, has_partial_ranking, has_full_ranking FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID';",
          "verification": {
            "guided_ranking_answers": "Contains all q1-q12 with answers and timestamps",
            "firmographics": "Contains departments, methodologies, user_count",
            "has_partial_ranking": "true",
            "has_full_ranking": "true"
          }
        },
        {
          "step": 7,
          "action": "Check analytics.events for guided ranking answers",
          "sql": "SELECT COUNT(*) FROM analytics.events WHERE session_id = 'YOUR_SESSION_ID' AND event_type = 'guided_ranking_answer';",
          "verification": "At least 12 rows (one per question) + 1 completion event"
        }
      ],
      "pass_criteria": "guided_ranking_answers populated, firmographics extracted, flags set"
    },
    "test_4_tool_click_tracking": {
      "description": "Verify monetization tracking (Try Free, Add to Compare, View Details)",
      "prerequisite": "Complete test_2 or test_3 to get tool recommendations",
      "steps": [
        {
          "step": 1,
          "action": "Scroll down to 'Your Top Recommendations' section",
          "expected": "See list of recommended tools with match scores"
        },
        {
          "step": 2,
          "action": "Click 'Try Free Trial' button on the #1 ranked tool",
          "expected": "New tab opens with tool's signup page"
        },
        {
          "step": 3,
          "action": "Return to PPM tool, click 'Add to Compare' on #2 ranked tool",
          "expected": "Button changes state (or comparison view updates)"
        },
        {
          "step": 4,
          "action": "Click 'View Detailed Breakdown' accordion on #3 ranked tool",
          "expected": "Accordion expands showing criteria breakdown"
        },
        {
          "step": 5,
          "action": "Check Supabase â†’ analytics.tool_clicks",
          "sql": "SELECT tool_id, action_type, position, match_score, context FROM analytics.tool_clicks WHERE session_id = 'YOUR_SESSION_ID' ORDER BY created_at;",
          "verification": {
            "row_count": "3",
            "action_types": "try_free, add_to_compare, view_details",
            "positions": "1, 2, 3",
            "context": "Contains criteria_count, meets_requirements"
          }
        },
        {
          "step": 6,
          "action": "Check visitor_sessions.tools_clicked",
          "sql": "SELECT tools_clicked FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID';",
          "verification": {
            "structure": "{\"<tool_id>\": {\"try_free\": 1, \"add_to_compare\": 0, \"view_details\": 0}, ...}",
            "tool_count": "At least 3 tools"
          }
        },
        {
          "step": 7,
          "action": "Click 'Try Free Trial' button AGAIN on same tool",
          "purpose": "Test counter increment"
        },
        {
          "step": 8,
          "action": "Verify tools_clicked incremented",
          "sql": "SELECT tools_clicked FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID';",
          "verification": {
            "try_free_count": "2 (incremented)",
            "tool_clicks_table": "2 rows for try_free with same tool_id"
          }
        }
      ],
      "pass_criteria": "All 3 action types tracked, counters increment, context captured"
    },
    "test_5_report_sent_tracking": {
      "description": "Verify conversion event tracking when email report sent",
      "steps": [
        {
          "step": 1,
          "action": "Click 'Get Your Custom Report' or 'Send Report' button",
          "expected": "Email form modal opens"
        },
        {
          "step": 2,
          "action": "Fill in form: First Name: Test, Last Name: User, Email: test@example.com",
          "note": "Use real email if you want to verify email delivery"
        },
        {
          "step": 3,
          "action": "Click 'Send Report'",
          "expected": "Loading spinner, then success message"
        },
        {
          "step": 4,
          "action": "Check Supabase â†’ analytics.visitor_sessions",
          "sql": "SELECT email, first_name, last_name, match_scores, has_sent_report FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID';",
          "verification": {
            "email": "test@example.com",
            "first_name": "Test",
            "last_name": "User",
            "match_scores": "Array of tools with scores and ranks",
            "has_sent_report": "true"
          }
        },
        {
          "step": 5,
          "action": "Check analytics.events for report_sent",
          "sql": "SELECT event_type, event_data FROM analytics.events WHERE session_id = 'YOUR_SESSION_ID' AND event_type = 'report_sent';",
          "verification": {
            "row_count": "1",
            "event_data": "Contains email, tools, criteria, match_scores"
          }
        },
        {
          "step": 6,
          "action": "Verify complete session data",
          "sql": "SELECT * FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID';",
          "verification": {
            "is_active": "true",
            "has_manual_ranking": "true or false (depending on test_2)",
            "has_partial_ranking": "true or false (depending on test_3)",
            "has_full_ranking": "true or false (depending on test_3)",
            "has_sent_report": "true",
            "criteria_rankings": "Populated",
            "tools_clicked": "Populated if test_4 completed",
            "email": "Populated",
            "firmographics": "Populated if test_3 completed"
          }
        }
      ],
      "pass_criteria": "Full session captured, conversion flag set, match scores stored"
    },
    "test_6_llm_export": {
      "description": "Verify LLM-parsable data export",
      "steps": [
        {
          "step": 1,
          "action": "Get your session ID from localStorage",
          "how": "Console: localStorage.getItem('analytics_session_id')"
        },
        {
          "step": 2,
          "action": "Call get_session_data RPC function",
          "sql": "SELECT get_session_data('YOUR_SESSION_ID');",
          "expected": "Single JSONB blob with session + events + clicks + impressions"
        },
        {
          "step": 3,
          "action": "Copy the JSON output",
          "purpose": "Feed to LLM for quality testing"
        },
        {
          "step": 4,
          "action": "Open ChatGPT or Claude",
          "prompt": "Analyze this user session data from a PPM tool recommendation system. Is this a real person? Does the data look complete? Does their behavior make sense? Assign a quality score 0-100 and identify any issues.",
          "paste": "The JSON from step 2"
        },
        {
          "step": 5,
          "action": "Review LLM analysis",
          "expected_output": "Quality score 80-100, confirms realistic behavior, identifies data completeness"
        },
        {
          "step": 6,
          "action": "Alternative: Export as pretty JSON",
          "sql": "SELECT jsonb_pretty(get_session_data('YOUR_SESSION_ID'));",
          "purpose": "Human-readable format"
        }
      ],
      "pass_criteria": "LLM successfully parses data and provides meaningful analysis"
    }
  },
  "sql_verification_queries": {
    "funnel_metrics": {
      "query": "SELECT \n  COUNT(*) as total_sessions,\n  SUM(CASE WHEN is_active THEN 1 ELSE 0 END) as active_sessions,\n  SUM(CASE WHEN has_manual_ranking THEN 1 ELSE 0 END) as manual_rankings,\n  SUM(CASE WHEN has_partial_ranking THEN 1 ELSE 0 END) as partial_rankings,\n  SUM(CASE WHEN has_full_ranking THEN 1 ELSE 0 END) as full_rankings,\n  SUM(CASE WHEN has_sent_report THEN 1 ELSE 0 END) as reports_sent\nFROM analytics.visitor_sessions\nWHERE created_at > NOW() - INTERVAL '24 hours';",
      "purpose": "Overall funnel health check"
    },
    "recent_sessions": {
      "query": "SELECT \n  session_id,\n  created_at,\n  is_active,\n  has_manual_ranking,\n  has_full_ranking,\n  has_sent_report,\n  email\nFROM analytics.visitor_sessions\nORDER BY created_at DESC\nLIMIT 10;",
      "purpose": "Quick overview of recent activity"
    },
    "tool_click_counts": {
      "query": "SELECT \n  t.name as tool_name,\n  tc.action_type,\n  COUNT(*) as click_count,\n  AVG(tc.match_score) as avg_match_score\nFROM analytics.tool_clicks tc\nJOIN public.tools t ON tc.tool_id = t.id\nWHERE tc.created_at > NOW() - INTERVAL '7 days'\nGROUP BY t.name, tc.action_type\nORDER BY click_count DESC;",
      "purpose": "Monetization tracking - which tools getting most clicks"
    },
    "high_intent_leads": {
      "query": "SELECT \n  vs.email,\n  vs.first_name,\n  vs.last_name,\n  vs.firmographics,\n  vs.tools_clicked,\n  vs.match_scores,\n  vs.created_at\nFROM analytics.visitor_sessions vs\nWHERE vs.has_sent_report = true\n  AND vs.tools_clicked::text LIKE '%try_free%'\n  AND vs.created_at > NOW() - INTERVAL '7 days'\nORDER BY vs.created_at DESC;",
      "purpose": "Highest quality leads (sent report + clicked Try Free)"
    },
    "criteria_popularity": {
      "query": "SELECT \n  key as criteria_id,\n  COUNT(*) as usage_count,\n  AVG((value)::int) as avg_score,\n  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY (value)::int) as median_score\nFROM analytics.visitor_sessions,\n     jsonb_each(criteria_rankings)\nWHERE has_manual_ranking = true\nGROUP BY key\nORDER BY usage_count DESC;",
      "purpose": "Which criteria users care about most"
    },
    "event_distribution": {
      "query": "SELECT \n  event_type,\n  event_category,\n  COUNT(*) as event_count,\n  COUNT(DISTINCT session_id) as unique_sessions\nFROM analytics.events\nWHERE created_at > NOW() - INTERVAL '24 hours'\nGROUP BY event_type, event_category\nORDER BY event_count DESC;",
      "purpose": "Verify all event types are firing"
    },
    "data_quality_check": {
      "query": "SELECT \n  COUNT(*) as total,\n  COUNT(CASE WHEN criteria_rankings = '{}' THEN 1 END) as empty_criteria,\n  COUNT(CASE WHEN guided_ranking_answers = '{}' THEN 1 END) as empty_guided,\n  COUNT(CASE WHEN tools_clicked = '{}' THEN 1 END) as no_clicks,\n  COUNT(CASE WHEN email IS NULL THEN 1 END) as no_email,\n  COUNT(CASE WHEN has_sent_report AND email IS NOT NULL THEN 1 END) as complete_conversions\nFROM analytics.visitor_sessions\nWHERE created_at > NOW() - INTERVAL '7 days';",
      "purpose": "Identify incomplete or suspicious sessions"
    }
  },
  "common_issues_and_fixes": {
    "issue_1_no_session_created": {
      "symptom": "Page loads but no row in visitor_sessions",
      "diagnosis": [
        "Check browser console for errors",
        "Verify analytics.trackPageView() is being called (should see console log)",
        "Check Supabase logs for RPC function errors",
        "Verify RPC function permissions (GRANT EXECUTE)"
      ],
      "fixes": [
        "Hard refresh (Ctrl+Shift+R) to clear cache",
        "Check Supabase connection in browser Network tab",
        "Verify NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY in .env.local"
      ]
    },
    "issue_2_criteria_not_updating": {
      "symptom": "Slider moves but criteria_rankings stays empty",
      "diagnosis": [
        "Check console for tracking errors",
        "Verify analytics.trackCriteriaRanking() is called (add console.log if needed)",
        "Check if session exists before slider interaction"
      ],
      "fixes": [
        "Ensure page view tracking completed before slider interaction",
        "Check if criteriaId and criteriaName are correctly passed",
        "Verify score is 1-5 (validated in RPC function)"
      ]
    },
    "issue_3_guided_answers_not_saved": {
      "symptom": "Complete guided ranking but guided_ranking_answers empty",
      "diagnosis": [
        "Check if handleSubmit in GuidedRankingForm.tsx is reached",
        "Verify answers object is populated before tracking",
        "Check console for tracking errors"
      ],
      "fixes": [
        "Ensure all questions have answers before submit",
        "Verify tracking call happens after form state update",
        "Check if question IDs match (q1, q2, etc.)"
      ]
    },
    "issue_4_tool_clicks_not_tracked": {
      "symptom": "Click buttons but tool_clicks table stays empty",
      "diagnosis": [
        "Check console for tracking errors",
        "Verify toolId is valid UUID",
        "Check if tool exists in public.tools (foreign key constraint)"
      ],
      "fixes": [
        "Ensure tool recommendations are loaded before clicking",
        "Verify onClick handlers are attached to buttons",
        "Check tool_id references valid tool in database"
      ]
    },
    "issue_5_report_tracking_fails": {
      "symptom": "Send report succeeds but has_sent_report stays false",
      "diagnosis": [
        "Check useEmailReport.ts for tracking errors",
        "Verify analytics.trackReportSent() is reached",
        "Check if email validation passes"
      ],
      "fixes": [
        "Ensure tracking happens after successful email send",
        "Verify match_scores array is properly formatted",
        "Check firmographics extraction from localStorage"
      ]
    }
  },
  "performance_testing": {
    "load_testing": {
      "tool": "Apache Bench (ab) or k6",
      "test_1": {
        "description": "Track 100 page views simultaneously",
        "command": "ab -n 100 -c 10 -p page_view.json -T application/json http://localhost:3000/api/track-page-view",
        "expected": "< 200ms average response time, 0% error rate"
      },
      "test_2": {
        "description": "Track 1000 events rapidly",
        "purpose": "Simulate high traffic",
        "expected": "Database handles load without slowdown"
      }
    },
    "query_performance": {
      "test_1": {
        "query": "EXPLAIN ANALYZE SELECT * FROM analytics.visitor_sessions WHERE session_id = 'test';",
        "expected": "Index Scan on idx_visitor_sessions_session_id, < 1ms execution"
      },
      "test_2": {
        "query": "EXPLAIN ANALYZE SELECT * FROM analytics.tool_clicks WHERE tool_id = '<some-uuid>' AND created_at > NOW() - INTERVAL '30 days';",
        "expected": "Bitmap Index Scan, < 10ms execution"
      },
      "test_3": {
        "query": "EXPLAIN ANALYZE SELECT criteria_rankings FROM analytics.visitor_sessions WHERE criteria_rankings @> '{\"ease_of_use\": 5}';",
        "expected": "Bitmap Index Scan using GIN index, < 50ms execution"
      }
    }
  },
  "production_monitoring": {
    "metrics_to_track": [
      {
        "metric": "Sessions per day",
        "query": "SELECT DATE(created_at), COUNT(*) FROM analytics.visitor_sessions GROUP BY DATE(created_at) ORDER BY DATE(created_at) DESC LIMIT 30;",
        "alert": "< 10 sessions/day (too low, might be broken)"
      },
      {
        "metric": "Conversion rate (report sent)",
        "query": "SELECT COUNT(CASE WHEN has_sent_report THEN 1 END)::float / COUNT(*) * 100 FROM analytics.visitor_sessions WHERE is_active = true;",
        "benchmark": "5-15% is normal for freemium tools"
      },
      {
        "metric": "Try Free click rate",
        "query": "SELECT COUNT(DISTINCT session_id)::float / (SELECT COUNT(*) FROM analytics.visitor_sessions WHERE is_active = true) * 100 FROM analytics.tool_clicks WHERE action_type = 'try_free';",
        "benchmark": "10-20% is good"
      },
      {
        "metric": "Average events per session",
        "query": "SELECT AVG(event_count) FROM (SELECT session_id, COUNT(*) as event_count FROM analytics.events GROUP BY session_id) sub;",
        "benchmark": "10-50 events (depends on engagement)"
      },
      {
        "metric": "Error rate",
        "source": "Browser console errors, Sentry alerts",
        "alert": "> 1% error rate on tracking calls"
      }
    ],
    "daily_checks": [
      "Run funnel_metrics query to verify data flowing",
      "Check for new sessions in last 24 hours",
      "Verify no RPC function errors in Supabase logs",
      "Check tool_clicks table growing (if traffic exists)"
    ],
    "weekly_checks": [
      "Run data_quality_check query to find anomalies",
      "Export 5 random sessions and spot-check data completeness",
      "Review top clicked tools for monetization opportunities",
      "Check criteria_popularity to understand user needs"
    ]
  },
  "success_criteria": {
    "launch_ready_checklist": [
      {
        "requirement": "All 6 end-to-end tests pass",
        "status": "PENDING"
      },
      {
        "requirement": "LLM can parse exported session data",
        "status": "PENDING"
      },
      {
        "requirement": "No linter errors in frontend code",
        "status": "COMPLETED"
      },
      {
        "requirement": "Database migration applied successfully",
        "status": "COMPLETED"
      },
      {
        "requirement": "All RPC functions callable from frontend",
        "status": "COMPLETED"
      },
      {
        "requirement": "Zero disruption - existing UI works perfectly",
        "status": "TO VERIFY"
      },
      {
        "requirement": "Tracking wrapped in try/catch - errors don't break UI",
        "status": "COMPLETED"
      },
      {
        "requirement": "Documentation complete (architecture, testing, plain English)",
        "status": "COMPLETED"
      }
    ],
    "definition_of_done": "When all 8 requirements above are marked COMPLETED, the system is production-ready."
  }
}

