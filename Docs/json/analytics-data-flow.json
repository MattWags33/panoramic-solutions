{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-09T00:10:00Z",
  "type": "ARCHITECTURE",
  "metadata": {
    "project": "Panoramic Solutions - PPM Tool",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true,
    "description": "Complete end-to-end data flow for the new analytics system"
  },
  "analytics_pipeline": {
    "overview": "User interactions flow through frontend → analytics service → Supabase RPC → database tables → rollup views",
    "components": [
      {
        "layer": "Frontend UI",
        "components": [
          "GuidedRankingForm.tsx - Question selection",
          "CriteriaSection.tsx - Criteria sliders",
          "EnhancedCompactToolCard.tsx - Tool interactions",
          "useEmailReport.ts - Recommendation sending"
        ],
        "responsibility": "Capture user interactions and trigger analytics events"
      },
      {
        "layer": "Analytics Service",
        "file": "src/lib/analytics.ts",
        "functions": [
          "initializeUser() - Create/update user record",
          "trackGuidedRankingAnswer() - Track question responses",
          "trackCriteriaRanking() - Track criteria ratings",
          "trackToolClick() - Track tool actions",
          "trackReportSent() - Track recommendation emails",
          "getUserAnalytics() - Retrieve complete user data"
        ],
        "responsibility": "Transform UI events into database operations via RPC calls"
      },
      {
        "layer": "Supabase RPC Functions",
        "file": "supabase/migrations/20251108_analytics_rpc_functions.sql",
        "functions": [
          {
            "name": "ensure_analytics_user",
            "parameters": ["session_id", "ip_address", "user_agent", "referrer", "utm_source", "utm_medium", "utm_campaign", "email", "first_name", "last_name"],
            "returns": "user_id (uuid)",
            "purpose": "Create or update user record on first visit or data collection"
          },
          {
            "name": "track_question_response",
            "parameters": ["session_id", "question_order", "choice_value"],
            "returns": "boolean success",
            "purpose": "Store guided ranking answers in junction table"
          },
          {
            "name": "track_criteria_response",
            "parameters": ["session_id", "criteria_id", "criteria_name", "score", "is_manual"],
            "returns": "boolean success",
            "purpose": "Store criteria ratings with manual/automatic flag"
          },
          {
            "name": "track_tool_action",
            "parameters": ["session_id", "tool_id", "tool_name", "action_type", "position", "match_score", "context_data"],
            "returns": "boolean success",
            "purpose": "Store tool interactions (click, view_details, add_to_compare, try_free)"
          },
          {
            "name": "track_recommendation_sent",
            "parameters": ["session_id", "recipient_email", "first_name", "last_name", "report_data"],
            "returns": "recommendation_id (uuid)",
            "purpose": "Store email report metadata and link to user analytics"
          },
          {
            "name": "get_user_analytics",
            "parameters": ["session_id"],
            "returns": "complete user analytics object with questions, criteria, tools",
            "purpose": "Retrieve all analytics data for a user session"
          }
        ],
        "responsibility": "Business logic layer that validates, transforms, and persists data"
      },
      {
        "layer": "Database Tables",
        "schema": "analytics",
        "tables": [
          {
            "name": "users",
            "purpose": "Core user/session tracking",
            "key_fields": ["user_id", "session_id", "email", "first_name", "last_name", "first_seen_at", "last_seen_at"],
            "tracking": "Unique user identification and basic demographics"
          },
          {
            "name": "user_question_responses",
            "purpose": "Junction table for guided ranking answers",
            "key_fields": ["response_id", "user_id", "question_order", "choice_value", "responded_at"],
            "tracking": "Historical question responses with preservation of old answers"
          },
          {
            "name": "user_criteria_responses",
            "purpose": "Junction table for criteria ratings",
            "key_fields": ["response_id", "user_id", "criteria_id", "criteria_name", "score", "is_manual", "rated_at"],
            "tracking": "All criteria adjustments by user with manual/automatic flag"
          },
          {
            "name": "user_tool_actions",
            "purpose": "Junction table for tool interactions",
            "key_fields": ["action_id", "user_id", "tool_id", "tool_name", "action_type", "position", "match_score", "context_data", "action_timestamp"],
            "tracking": "Every tool interaction for monetization and UX analysis",
            "action_types": ["click", "view_details", "add_to_compare", "try_free"]
          },
          {
            "name": "recommendations",
            "purpose": "Email report tracking",
            "key_fields": ["recommendation_id", "user_id", "recipient_email", "sent_at", "report_data"],
            "tracking": "Conversion events and recommendation quality"
          },
          {
            "name": "questions",
            "purpose": "Dynamic question definitions",
            "key_fields": ["question_id", "question_order", "question_text", "question_type", "is_active"],
            "tracking": "Allows changing questions without losing historical data"
          },
          {
            "name": "question_choices",
            "purpose": "Dynamic answer options",
            "key_fields": ["choice_id", "question_id", "choice_value", "choice_text", "is_active"],
            "tracking": "Allows changing answer options without losing historical data"
          }
        ],
        "responsibility": "Persistent storage with referential integrity via foreign keys"
      },
      {
        "layer": "Rollup Views",
        "schema": "analytics",
        "views": [
          {
            "name": "user_activity_rollups",
            "purpose": "High-level user engagement metrics",
            "aggregations": [
              "total_page_views",
              "questions_answered",
              "criteria_rated",
              "tools_interacted_with",
              "total_tool_actions",
              "has_recommendations"
            ],
            "use_case": "Dashboard metrics, unique user counts, engagement analysis"
          },
          {
            "name": "tool_action_rollups",
            "purpose": "Tool-level performance metrics",
            "aggregations": [
              "total_actions",
              "unique_users",
              "total_clicks",
              "total_views",
              "total_compares",
              "total_try_frees",
              "avg_match_score",
              "avg_position"
            ],
            "use_case": "Vendor reporting, tool effectiveness, monetization data"
          },
          {
            "name": "question_response_rollups",
            "purpose": "Question-level analytics",
            "aggregations": [
              "total_responses",
              "unique_users_answered",
              "most_common_choice"
            ],
            "use_case": "Guided ranking effectiveness, A/B testing, user preferences"
          }
        ],
        "responsibility": "Pre-aggregated analytics for fast dashboard queries"
      }
    ]
  },
  "data_flow_scenarios": [
    {
      "scenario": "New User Visits Tool",
      "steps": [
        {
          "step": 1,
          "user_action": "User lands on PPM tool page",
          "frontend_trigger": "initializeAnalytics() called in app initialization",
          "analytics_call": "analytics.initializeUser()",
          "rpc_function": "ensure_analytics_user()",
          "database_impact": "INSERT/UPDATE in analytics.users table",
          "result": "User record created with session_id, IP, user_agent, referrer, UTM params"
        },
        {
          "step": 2,
          "user_action": "User answers guided ranking question",
          "frontend_trigger": "Answer selection in GuidedRankingForm.tsx",
          "analytics_call": "analytics.trackGuidedRankingAnswer({questionOrder, choiceValue})",
          "rpc_function": "track_question_response()",
          "database_impact": "INSERT in analytics.user_question_responses",
          "result": "Question response stored with timestamp, linked to user via user_id"
        },
        {
          "step": 3,
          "user_action": "User adjusts criteria slider",
          "frontend_trigger": "onValueChange in CriteriaSection.tsx",
          "analytics_call": "analytics.trackCriteriaRanking({criteriaId, score, isManual})",
          "rpc_function": "track_criteria_response()",
          "database_impact": "INSERT in analytics.user_criteria_responses",
          "result": "Criteria rating stored with is_manual=true flag"
        },
        {
          "step": 4,
          "user_action": "User clicks 'View Details' on a tool",
          "frontend_trigger": "handleViewDetailsClick in EnhancedCompactToolCard.tsx",
          "analytics_call": "analytics.trackToolClick({toolId, actionType: 'view_details', position, matchScore})",
          "rpc_function": "track_tool_action()",
          "database_impact": "INSERT in analytics.user_tool_actions",
          "result": "Tool interaction stored with context (position, match_score, expanding=true)"
        },
        {
          "step": 5,
          "user_action": "User clicks 'Try Free' button",
          "frontend_trigger": "handleTryFreeClick in EnhancedCompactToolCard.tsx",
          "analytics_call": "analytics.trackToolClick({actionType: 'try_free'})",
          "rpc_function": "track_tool_action()",
          "database_impact": "INSERT in analytics.user_tool_actions",
          "dual_tracking": "Also sends to PostHog via trackToolTryFreeClick()",
          "result": "High-value action tracked for monetization, user navigates to tool's trial page"
        },
        {
          "step": 6,
          "user_action": "User sends email report",
          "frontend_trigger": "handleSubmit in useEmailReport.ts",
          "analytics_call": "analytics.trackReportSent({firstName, lastName})",
          "rpc_function": "track_recommendation_sent()",
          "database_impact": "INSERT in analytics.recommendations",
          "additional_action": "Updates users table with email/name if not already set",
          "result": "Conversion event captured, recommendation_id returned for future reference"
        }
      ]
    },
    {
      "scenario": "Returning User Resumes Guided Rankings",
      "steps": [
        {
          "step": 1,
          "user_action": "User returns to site (same session_id in localStorage)",
          "frontend_trigger": "GuidedRankingForm.tsx useEffect on mount",
          "analytics_call": "analytics.getUserAnalytics()",
          "rpc_function": "get_user_analytics()",
          "database_query": "Joins users + user_question_responses",
          "result": "Previous answers loaded from database, form pre-populated"
        },
        {
          "step": 2,
          "user_action": "User changes answer to previous question",
          "frontend_trigger": "Answer selection in GuidedRankingForm.tsx",
          "analytics_call": "analytics.trackGuidedRankingAnswer()",
          "rpc_function": "track_question_response()",
          "database_impact": "UPDATE existing record in user_question_responses",
          "result": "User's preference update persisted, old_value tracked in history"
        }
      ]
    }
  ],
  "testing_verification_points": [
    {
      "checkpoint": "User Record Creation",
      "table": "analytics.users",
      "verify_query": "SELECT * FROM analytics.users WHERE session_id = '{test_session_id}';",
      "expected_fields": ["user_id", "session_id", "ip_address", "user_agent", "first_seen_at", "page_view_count = 1"]
    },
    {
      "checkpoint": "Question Response Tracking",
      "table": "analytics.user_question_responses",
      "verify_query": "SELECT * FROM analytics.user_question_responses WHERE user_id = '{test_user_id}';",
      "expected_data": "Rows for each answered question with correct question_order and choice_value"
    },
    {
      "checkpoint": "Criteria Rating Tracking",
      "table": "analytics.user_criteria_responses",
      "verify_query": "SELECT * FROM analytics.user_criteria_responses WHERE user_id = '{test_user_id}' ORDER BY rated_at DESC;",
      "expected_data": "Rows for each criteria adjustment with is_manual flag"
    },
    {
      "checkpoint": "Tool Action Tracking",
      "table": "analytics.user_tool_actions",
      "verify_query": "SELECT tool_name, action_type, position, match_score, context_data FROM analytics.user_tool_actions WHERE user_id = '{test_user_id}' ORDER BY action_timestamp;",
      "expected_data": "Chronological list of all tool interactions with rich context"
    },
    {
      "checkpoint": "Recommendation Tracking",
      "table": "analytics.recommendations",
      "verify_query": "SELECT * FROM analytics.recommendations WHERE user_id = '{test_user_id}';",
      "expected_data": "Email report record with recipient_email and complete report_data JSON"
    },
    {
      "checkpoint": "User Activity Rollup",
      "view": "analytics.user_activity_rollups",
      "verify_query": "SELECT * FROM analytics.user_activity_rollups WHERE session_id = '{test_session_id}';",
      "expected_data": "Aggregated metrics: questions_answered, criteria_rated, tools_interacted_with, etc."
    },
    {
      "checkpoint": "Tool Performance Rollup",
      "view": "analytics.tool_action_rollups",
      "verify_query": "SELECT * FROM analytics.tool_action_rollups WHERE tool_name = 'Smartsheet' LIMIT 1;",
      "expected_data": "Aggregated tool metrics: total_actions, unique_users, action type counts"
    }
  ],
  "why_fully_set_up": {
    "complete_pipeline": "Every layer from UI to database is connected and functional",
    "reasons": [
      {
        "component": "Frontend Event Handlers",
        "status": "✅ Complete",
        "details": "All user interactions in GuidedRankingForm, CriteriaSection, EnhancedCompactToolCard now call analytics service"
      },
      {
        "component": "Analytics Service Layer",
        "status": "✅ Complete",
        "details": "analytics.ts has working functions for every tracking need, no more silent failures"
      },
      {
        "component": "Supabase RPC Functions",
        "status": "✅ Complete & Tested",
        "details": "All 6 RPC functions created, tested, and returning correct data"
      },
      {
        "component": "Database Schema",
        "status": "✅ Complete",
        "details": "All tables created with proper foreign keys, indexes, and RLS policies"
      },
      {
        "component": "Rollup Views",
        "status": "✅ Complete",
        "details": "Pre-aggregated views for fast dashboard queries"
      },
      {
        "component": "TypeScript Types",
        "status": "✅ Complete",
        "details": "Full type safety across the entire analytics pipeline"
      },
      {
        "component": "Error Handling",
        "status": "✅ Robust",
        "details": "Try-catch blocks ensure analytics failures don't break UI"
      },
      {
        "component": "Dual Tracking",
        "status": "✅ Implemented",
        "details": "Critical events sent to both PostHog (dashboards) and Supabase (monetization)"
      },
      {
        "component": "Backward Compatibility",
        "status": "✅ Maintained",
        "details": "localStorage fallback ensures smooth transition"
      }
    ]
  },
  "key_improvements_over_old_system": [
    {
      "issue": "Silent Analytics Failures",
      "old_behavior": "analytics.ts called non-existent RPC functions, failed silently",
      "new_behavior": "All RPC functions exist and work, with error logging"
    },
    {
      "issue": "No User Persistence",
      "old_behavior": "localStorage only, lost on cache clear",
      "new_behavior": "Database storage with session_id tracking, works across devices"
    },
    {
      "issue": "No Tool Interaction Data",
      "old_behavior": "Only PostHog events, no queryable database",
      "new_behavior": "Rich interaction data in database for monetization reports"
    },
    {
      "issue": "No Unique User Metrics",
      "old_behavior": "PostHog page view counting issues",
      "new_behavior": "Database-backed unique user counts via rollup views"
    },
    {
      "issue": "Monolithic visitor_sessions",
      "old_behavior": "JSON fields, no relational queries possible",
      "new_behavior": "Normalized schema with junction tables for flexibility"
    }
  ]
}


