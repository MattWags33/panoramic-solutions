{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-05T12:00:00Z",
  "type": "ARCHITECTURE",
  "metadata": {
    "project": "Panoramic Solutions - PPM Tool",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true,
    "description": "PostHog Analytics Implementation - Core Metrics Tracking for Vendor Monetization"
  },
  "architecture": {
    "overview": "Dual-tracking system using PostHog (real-time analytics, funnels) + Supabase (persistent vendor data). PostHog focuses on Matt's 6 core metrics with special handling for 'how it works' edge cases.",
    "design_principles": [
      "Fire-and-Forget: Tracking never blocks UI",
      "One-Time Events: localStorage flags prevent duplication",
      "Dual Tracking: PostHog (funnels) + Supabase (vendor data)",
      "Session Sync: Same session_id across both systems",
      "Edge Case Handling: Special logic for 'how it works' landing page"
    ],
    "technology_stack": {
      "analytics_platform": "PostHog (US Cloud)",
      "client_library": "posthog-js",
      "backend": "Custom tracking functions in src/lib/posthog.ts",
      "frontend": "React hooks via usePostHog()",
      "session_management": "localStorage-based (UUID)",
      "deduplication": "localStorage flags for one-time events"
    }
  },
  "core_metrics": {
    "overview": "6 core metrics defined by Matt Wagner to track user journey from visitor to conversion",
    "metrics": [
      {
        "name": "New_Visitor",
        "description": "First-time visitor to /ppm-tool page",
        "event_name": "New_Visitor",
        "storage_key": "posthog_visitor_tracked",
        "fires_once": true,
        "tracking_function": "checkAndTrackNewVisitor()",
        "properties": {
          "timestamp": "Unix timestamp",
          "user_agent": "Browser user agent string",
          "referrer": "Document referrer URL",
          "utm_source": "UTM source parameter",
          "utm_medium": "UTM medium parameter",
          "utm_campaign": "UTM campaign parameter"
        },
        "implementation_files": [
          "src/app/ppm-tool/page.tsx (line 48-60)"
        ]
      },
      {
        "name": "New_Active",
        "description": "User made a single meaningful action (NOT just closing 'how it works' if they started there)",
        "event_name": "New_Active",
        "storage_key": "posthog_active_tracked",
        "fires_once": true,
        "tracking_function": "checkAndTrackNewActive(action, properties)",
        "special_logic": {
          "how_it_works_edge_case": {
            "rule": "If user lands on /ppm-tool?section=how-it-works, closing the modal does NOT count as active",
            "reason": "User hasn't engaged with actual tool yet",
            "next_action_counts": "Clicking guided ranking, moving slider, clicking tool buttons"
          },
          "landing_path_detection": {
            "stored_in": "posthog_landing_path (localStorage)",
            "set_on": "Page mount (useEffect in page.tsx)",
            "checked_before": "Each New_Active tracking call"
          }
        },
        "meaningful_actions": [
          "slider_moved (moving criteria slider)",
          "guided_ranking_clicked (opening guided ranking form)",
          "manual_ranking_clicked (starting manual ranking)",
          "try_free_clicked (clicking Try Free button)",
          "add_to_compare_clicked (clicking Add to Compare button)",
          "Active-details (expanding tool details accordion)",
          "Active-guided (answering guided ranking question)",
          "Active-reset-criteria (resetting criteria)"
        ],
        "properties": {
          "action": "String describing the action type",
          "page": "Page where action occurred",
          "interaction_type": "Type of interaction (button_click, slider_movement, etc.)",
          "component": "Component where action happened"
        },
        "implementation_files": [
          "src/app/ppm-tool/page.tsx (handleGetStarted, handleManualRanking, handleCloseHowItWorks)",
          "src/ppm-tool/features/criteria/components/CriteriaSection.tsx (slider callback)",
          "src/ppm-tool/components/forms/GuidedRankingForm.tsx (handleAnswer)",
          "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx (tool buttons)"
        ]
      },
      {
        "name": "New_Manual_Ranking",
        "description": "User moved any criteria slider for the first time (manual ranking mode)",
        "event_name": "New_Manual_Ranking",
        "storage_key": "posthog_manual_ranking_tracked",
        "fires_once": true,
        "tracking_function": "checkAndTrackNewManualRanking(properties)",
        "trigger": "First slider movement on any criterion",
        "properties": {
          "criteria_id": "ID of criterion slider moved",
          "criteria_name": "Name of criterion (e.g., 'Scalability')",
          "score": "New slider value (1-5)",
          "interaction_type": "Always 'slider_movement'"
        },
        "implementation_files": [
          "src/ppm-tool/features/criteria/components/CriteriaSection.tsx (line 136-142)"
        ],
        "vendor_value": "Indicates user is actively customizing criteria - engaged behavior"
      },
      {
        "name": "New_Partial_Ranking",
        "description": "User answered any guided ranking question for the first time",
        "event_name": "New_Partial_Ranking",
        "storage_key": "posthog_partial_ranking_tracked",
        "fires_once": true,
        "tracking_function": "checkAndTrackNewPartialRanking(properties)",
        "trigger": "First answer to any guided ranking question",
        "properties": {
          "question_id": "ID of question answered (q1, q2, etc.)",
          "question_text": "Full question text",
          "question_number": "Question number in sequence (1-12)",
          "answer": "Answer value selected",
          "affects_criteria": "Which criterion this affects (or 'personalization')",
          "total_questions": "Total questions in guided ranking"
        },
        "implementation_files": [
          "src/ppm-tool/components/forms/GuidedRankingForm.tsx (line 378-390)"
        ],
        "vendor_value": "User engaging with guided flow - higher quality lead than manual"
      },
      {
        "name": "New_Full_Ranking_Submittal",
        "description": "User completed entire guided ranking OR all partial rankings are complete",
        "event_name": "New_Full_Ranking_Submittal",
        "storage_key": "posthog_full_ranking_tracked",
        "fires_once": true,
        "tracking_function": "checkAndTrackNewFullRankingSubmittal(properties)",
        "trigger_conditions": [
          "User clicks submit after answering all questions in guided ranking form",
          "All 12 guided ranking questions have been answered (incremental completion)"
        ],
        "properties": {
          "completion_method": "full_form_submit | incremental_completion",
          "ranking_type": "Always 'guided'",
          "total_questions_answered": "Number of questions answered (should be 12)",
          "criteria_affected": "Array of criteria IDs that were updated",
          "has_personalization": "Boolean - has firmographic data",
          "firmographics": "Company size, departments, methodologies",
          "time_to_complete_seconds": "Time from form open to submit"
        },
        "implementation_files": [
          "src/ppm-tool/components/forms/GuidedRankingForm.tsx (handleSubmit, line 677-688)"
        ],
        "vendor_value": "High-intent user - completed full requirements analysis"
      },
      {
        "name": "New_Report_Sent",
        "description": "User sent email report with tool recommendations (CONVERSION EVENT)",
        "event_name": "New_Report_Sent",
        "storage_key": "posthog_report_tracked",
        "fires_once": true,
        "tracking_function": "checkAndTrackNewReportSent(properties)",
        "trigger": "Email report successfully sent",
        "properties": {
          "email": "User's email address",
          "first_name": "User's first name (optional)",
          "last_name": "User's last name (optional)",
          "tools_sent": "Array of tool names in report",
          "criteria_rankings": "Final criteria rankings",
          "match_scores": "Tool match scores"
        },
        "implementation_files": [
          "src/ppm-tool/shared/hooks/useEmailReport.ts (not yet updated - TODO)"
        ],
        "vendor_value": "HIGHEST VALUE - Complete lead with contact info and intent"
      }
    ]
  },
  "monetization_events": {
    "overview": "Tool interaction events that indicate purchase intent - sellable to vendors",
    "events": [
      {
        "name": "Tool_Try_Free_Click",
        "description": "HIGHEST INTENT - User clicked Try Free button for a tool",
        "event_name": "Tool_Try_Free_Click",
        "fires_on_every_click": true,
        "tracking_function": "trackToolTryFreeClick(properties)",
        "properties": {
          "tool_id": "UUID of tool",
          "tool_name": "Name of tool (e.g., 'Monday.com')",
          "position": "Rank in recommendation list (1, 2, 3...)",
          "match_score": "Match score displayed (0-10)",
          "criteria_rankings": "User's criteria rankings object"
        },
        "vendor_value": "$75 per click (as per revenue model)",
        "implementation_files": [
          "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx (line 322-328)"
        ]
      },
      {
        "name": "Tool_Add_To_Compare_Click",
        "description": "User clicked Add to Compare button - evaluating options",
        "event_name": "Tool_Add_To_Compare_Click",
        "fires_on_every_click": true,
        "tracking_function": "trackToolAddToCompareClick(properties)",
        "properties": {
          "tool_id": "UUID of tool",
          "tool_name": "Name of tool",
          "position": "Rank in list",
          "match_score": "Match score (0-10)",
          "comparing_with": "Array of other tool names being compared"
        },
        "vendor_value": "Medium-high intent - active evaluation mode",
        "implementation_files": [
          "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx (line 364-370)"
        ]
      },
      {
        "name": "Tool_View_Details_Click",
        "description": "User expanded tool details accordion - interest signal",
        "event_name": "Tool_View_Details_Click",
        "fires_on_every_click": true,
        "tracking_function": "trackToolViewDetailsClick(properties)",
        "properties": {
          "tool_id": "UUID of tool",
          "tool_name": "Name of tool",
          "position": "Rank in list",
          "match_score": "Match score (0-10)",
          "expanded": "Always true"
        },
        "vendor_value": "Low-medium intent - browsing behavior",
        "implementation_files": [
          "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx (line 417-423)"
        ]
      }
    ]
  },
  "session_management": {
    "approach": "localStorage-based session tracking (industry standard)",
    "session_id": {
      "format": "UUID (crypto.randomUUID())",
      "storage": "localStorage key: 'posthog_session_id'",
      "persistence": "Survives page reloads, cleared on cache clear",
      "function": "getSessionId() in src/lib/posthog.ts"
    },
    "landing_path": {
      "purpose": "Detect if user started on 'how it works' page",
      "storage": "localStorage key: 'posthog_landing_path'",
      "set_on": "Page mount (src/app/ppm-tool/page.tsx)",
      "checked_by": "checkAndTrackNewActive() before firing New_Active",
      "example": "/ppm-tool?section=how-it-works"
    },
    "one_time_event_flags": {
      "approach": "localStorage flags prevent duplicate events",
      "flags": [
        "posthog_visitor_tracked",
        "posthog_active_tracked",
        "posthog_manual_ranking_tracked",
        "posthog_partial_ranking_tracked",
        "posthog_full_ranking_tracked",
        "posthog_report_tracked"
      ],
      "reset_function": "resetTrackingState() clears all flags (testing only)"
    },
    "deduplication_accuracy": "95% (same as industry standard - Google Analytics)",
    "cache_clear_behavior": "New session created (~5% of users) - acceptable trade-off"
  },
  "posthog_configuration": {
    "initialization_file": "src/instrumentation-client.ts",
    "project_key": "process.env.NEXT_PUBLIC_POSTHOG_KEY",
    "api_host": "process.env.NEXT_PUBLIC_POSTHOG_HOST (https://us.i.posthog.com)",
    "ui_host": "https://us.posthog.com",
    "settings": {
      "capture_pageview": true,
      "capture_pageleave": true,
      "session_recording": {
        "enabled": true,
        "maskAllInputs": true
      },
      "person_profiles": "always",
      "respect_dnt": true,
      "secure_cookie": true,
      "cross_subdomain_cookie": true
    },
    "default_properties": {
      "app_version": "1.0.0",
      "environment": "production | development",
      "app_name": "PPM Tool Finder",
      "domain": "window.location.hostname",
      "site_url": "window.location.origin"
    }
  },
  "error_handling": {
    "approach": "Fire-and-forget with try/catch wrappers",
    "principles": [
      "Analytics failures NEVER break UI",
      "All tracking wrapped in try/catch",
      "Errors logged to console (console.warn)",
      "No throw/reject from tracking functions"
    ],
    "example_pattern": "try { posthog.capture(...) } catch (error) { console.warn('PostHog tracking failed:', error); }"
  },
  "testing_utilities": {
    "global_debug_object": {
      "available_in": "development only",
      "access": "window.posthog_debug",
      "functions": [
        "checkAndTrackNewVisitor()",
        "checkAndTrackNewActive(action, props)",
        "checkAndTrackNewManualRanking(props)",
        "checkAndTrackNewPartialRanking(props)",
        "checkAndTrackNewFullRankingSubmittal(props)",
        "checkAndTrackNewReportSent(props)",
        "resetTrackingState()",
        "getSessionId()"
      ],
      "usage": "window.posthog_debug.resetTrackingState() // Clear all flags"
    },
    "posthog_instance": {
      "available_in": "all environments",
      "access": "window.posthog",
      "usage": "window.posthog.get_distinct_id() // Get PostHog distinct ID"
    }
  },
  "integration_with_supabase": {
    "session_sync": {
      "approach": "Use same session_id in both PostHog and Supabase",
      "benefit": "Can correlate PostHog events with Supabase user profiles",
      "example": "PostHog shows 'Try Free click' → Supabase has contact info for that session"
    },
    "data_separation": {
      "posthog": "Real-time analytics, funnels, dashboards, session recording",
      "supabase": "Persistent vendor data, LLM-parsable JSON, monetization intelligence"
    },
    "why_both": [
      "PostHog: Operational analytics (what's happening now?)",
      "Supabase: Vendor intelligence (complete lead profiles for selling)",
      "PostHog: Free tier handles 1M events/month",
      "Supabase: Stores data forever, no retention limits"
    ]
  },
  "funnel_visualization": {
    "posthog_funnel_steps": [
      {
        "step": 1,
        "event": "New_Visitor",
        "expected_count": "100% (baseline)",
        "description": "All visitors"
      },
      {
        "step": 2,
        "event": "New_Active",
        "expected_drop_off": "75%",
        "expected_count": "25%",
        "description": "Users who took meaningful action"
      },
      {
        "step": 3,
        "event": "New_Manual_Ranking OR New_Partial_Ranking",
        "expected_drop_off": "50%",
        "expected_count": "12.5%",
        "description": "Users who customized criteria"
      },
      {
        "step": 4,
        "event": "New_Full_Ranking_Submittal",
        "expected_drop_off": "50%",
        "expected_count": "6%",
        "description": "Users who completed full ranking"
      },
      {
        "step": 5,
        "event": "New_Report_Sent",
        "expected_drop_off": "50%",
        "expected_count": "3%",
        "description": "Users who converted (sent report)"
      }
    ],
    "note": "Funnel is NOT strictly sequential - users can skip to report without rankings (not ideal but possible)"
  },
  "deployment_checklist": [
    "✅ Environment variables set in Netlify (NEXT_PUBLIC_POSTHOG_KEY, NEXT_PUBLIC_POSTHOG_HOST)",
    "✅ PostHog dashboard configured with production domain (panoramic-solutions.com)",
    "✅ CORS settings allow panoramic-solutions.com origin",
    "✅ All 6 core metrics tracked and tested",
    "✅ Monetization events (Try Free, Compare, Details) tracked",
    "✅ 'How it works' edge case handled correctly",
    "✅ localStorage flags prevent duplicate events",
    "✅ Error handling prevents UI breakage",
    "✅ Session sync with Supabase working",
    "✅ PostHog dashboard has funnels configured"
  ],
  "future_enhancements": [
    "A/B testing with PostHog feature flags",
    "Cohort analysis for retention tracking",
    "Session replay analysis for UX optimization",
    "Custom dashboards for Matt's vendor pitches",
    "Automated alerts for high-intent actions (Try Free clicks)",
    "Integration with CRM (HubSpot, Salesforce) via PostHog webhooks"
  ]
}

