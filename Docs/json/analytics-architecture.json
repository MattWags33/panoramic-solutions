{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-05T00:00:00Z",
  "type": "ARCHITECTURE",
  "metadata": {
    "project": "Panoramic Solutions - PPM Tool",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true,
    "description": "LLM-Optimized Analytics System for Vendor Intelligence and Buyer Intent Data"
  },
  "architecture": {
    "overview": "JSON-first, LLM-parsable analytics system built on Supabase PostgreSQL with JSONB for flexible, rich event tracking. Designed to capture vendor-grade intelligence data for monetization.",
    "design_principles": [
      "JSON-First: All data stored in JSONB for easy LLM parsing",
      "Columns for Indexing: Key fields extracted for query performance",
      "Fire-and-Forget: Tracking never blocks UI",
      "Zero Disruption: Additive-only changes to frontend",
      "Vendor-Grade Data: Rich context for software companies to buy"
    ],
    "technology_stack": {
      "database": "Supabase (PostgreSQL 15.8)",
      "backend": "Supabase RPC Functions (PL/pgSQL)",
      "frontend": "Next.js + React",
      "analytics_client": "Custom analytics.ts service",
      "data_format": "JSONB (JSON Binary)",
      "indexing": "GIN indexes for JSONB, B-tree for columns"
    }
  },
  "database_schema": {
    "schemas": [
      {
        "name": "analytics",
        "description": "Internal analytics tracking - No direct API access. All interactions via RPC functions.",
        "security": "SECURITY DEFINER functions bypass RLS. No direct table grants."
      }
    ],
    "tables": [
      {
        "name": "analytics.visitor_sessions",
        "description": "Central session tracking with JSON-first design for LLM parsing",
        "purpose": "Track complete user journey from first visit to conversion",
        "key_fields": {
          "session_id": "Unique identifier (UUID stored in localStorage)",
          "ip_address": "For deduplication (best-effort, not perfect)",
          "criteria_rankings": "JSONB - All criteria scores (1-5)",
          "guided_ranking_answers": "JSONB - All questionnaire answers",
          "firmographics": "JSONB - Company size, departments, methodologies",
          "tools_clicked": "JSONB - Click counts per tool per action type",
          "match_scores": "JSONB - Final match scores if report sent",
          "email": "Contact info if report sent",
          "funnel_flags": "Boolean flags for fast funnel queries (is_active, has_manual_ranking, etc.)"
        },
        "indexes": [
          "session_id (unique)",
          "ip_address",
          "email (partial, where not null)",
          "created_at DESC",
          "funnel_flags (composite)",
          "GIN indexes on all JSONB columns"
        ],
        "sample_query": "SELECT criteria_rankings, guided_ranking_answers FROM analytics.visitor_sessions WHERE has_sent_report = true AND created_at > NOW() - INTERVAL '7 days';"
      },
      {
        "name": "analytics.events",
        "description": "Raw event stream for every user interaction",
        "purpose": "Granular log of all actions for detailed analysis",
        "key_fields": {
          "event_type": "page_view, criteria_ranking, guided_ranking_answer, tool_click, tool_impression, report_sent",
          "event_data": "JSONB - Full event payload (flexible structure)",
          "event_category": "navigation, interaction, conversion"
        },
        "indexes": [
          "session_id",
          "event_type",
          "created_at DESC",
          "GIN on event_data"
        ],
        "sample_query": "SELECT event_type, COUNT(*) FROM analytics.events WHERE created_at > NOW() - INTERVAL '7 days' GROUP BY event_type;"
      },
      {
        "name": "analytics.tool_impressions",
        "description": "Every time a tool is shown to a user",
        "purpose": "Track visibility and positioning of tools in results",
        "key_fields": {
          "tool_id": "References public.tools",
          "position": "Rank in recommendation list (1, 2, 3...)",
          "match_score": "Score displayed to user",
          "match_breakdown": "JSONB - Detailed criteria scores",
          "competing_tools": "JSONB - Other tools shown at same time"
        },
        "indexes": [
          "session_id",
          "tool_id",
          "created_at DESC",
          "GIN on match_breakdown"
        ],
        "vendor_value": "Shows how often a tool appears in results and at what rank"
      },
      {
        "name": "analytics.tool_clicks",
        "description": "Monetization tracking: compare, try_free, view_details",
        "purpose": "Track high-intent actions that indicate purchase interest",
        "key_fields": {
          "tool_id": "References public.tools",
          "action_type": "try_free, add_to_compare, view_details",
          "position": "Where tool was ranked when clicked",
          "match_score": "Match score at time of click",
          "context": "JSONB - Full session context (criteria, firmographics, competing tools)"
        },
        "indexes": [
          "session_id",
          "tool_id",
          "action_type",
          "created_at DESC"
        ],
        "vendor_value": "Direct monetization - shows who clicked Try Free (highest intent)"
      },
      {
        "name": "analytics.tool_comparisons",
        "description": "When user adds multiple tools to compare view",
        "purpose": "Track competitive analysis behavior",
        "key_fields": {
          "compared_tools": "JSONB - All tools in comparison",
          "comparison_criteria": "JSONB - Criteria used for comparison"
        },
        "vendor_value": "Shows which tools are being compared against each other"
      }
    ]
  },
  "rpc_functions": {
    "description": "All frontend interactions go through these SECURITY DEFINER functions",
    "functions": [
      {
        "name": "track_page_view",
        "purpose": "Initialize or update session on page load",
        "frontend_caller": "analytics.trackPageView()",
        "parameters": [
          "p_session_id: TEXT (from localStorage)",
          "p_path: TEXT",
          "p_referrer: TEXT",
          "p_utm_source: TEXT",
          "p_utm_medium: TEXT",
          "p_utm_campaign: TEXT"
        ],
        "behavior": "Creates session if new, updates last_seen_at if existing. Sets is_active=true if not landing on /how-it-works."
      },
      {
        "name": "track_criteria_ranking",
        "purpose": "Track slider movements (manual ranking)",
        "frontend_caller": "analytics.trackCriteriaRanking()",
        "frontend_files": [
          "src/ppm-tool/features/criteria/components/CriteriaSection.tsx (line 129)"
        ],
        "parameters": [
          "p_criteria_id: TEXT",
          "p_criteria_name: TEXT",
          "p_score: INT (1-5)",
          "p_is_manual: BOOLEAN"
        ],
        "behavior": "Updates criteria_rankings JSONB. Sets has_manual_ranking=true if manual. Logs to events table.",
        "data_captured": {
          "criteria_rankings": "Updated in real-time as user moves sliders",
          "has_manual_ranking": "Boolean flag for funnel tracking"
        }
      },
      {
        "name": "track_guided_ranking_answer",
        "purpose": "Track each guided ranking question answer",
        "frontend_caller": "analytics.trackGuidedRankingAnswer()",
        "frontend_files": [
          "src/ppm-tool/components/forms/GuidedRankingForm.tsx (line 681)"
        ],
        "parameters": [
          "p_question_id: TEXT",
          "p_question_text: TEXT",
          "p_answer: JSONB (flexible: number, string, array)",
          "p_affects_criteria: TEXT",
          "p_is_complete: BOOLEAN"
        ],
        "behavior": "Updates guided_ranking_answers JSONB. Sets has_partial_ranking=true. Sets has_full_ranking=true if complete.",
        "data_captured": {
          "guided_ranking_answers": "All questions and answers with timestamps",
          "firmographics": "Extracted from personalization questions"
        }
      },
      {
        "name": "track_tool_click",
        "purpose": "MONETIZATION KEY - Track Try Free, Add to Compare, View Details",
        "frontend_caller": "analytics.trackToolClick()",
        "frontend_files": [
          "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx (lines 308, 334, 371)"
        ],
        "parameters": [
          "p_tool_id: UUID",
          "p_tool_name: TEXT",
          "p_action_type: TEXT (try_free, add_to_compare, view_details)",
          "p_position: INT",
          "p_match_score: NUMERIC",
          "p_context: JSONB"
        ],
        "behavior": "Updates tools_clicked counter. Inserts to tool_clicks table. Logs to events table.",
        "vendor_value": "Direct monetization - highest intent actions",
        "data_captured": {
          "tools_clicked": "Nested JSON with click counts per tool per action",
          "tool_clicks": "Granular click log with full context"
        }
      },
      {
        "name": "track_tool_impression",
        "purpose": "Track when tool is displayed in results",
        "frontend_caller": "analytics.trackToolImpression()",
        "parameters": [
          "p_tool_id: UUID",
          "p_position: INT",
          "p_match_score: NUMERIC",
          "p_match_breakdown: JSONB",
          "p_competing_tools: JSONB"
        ],
        "behavior": "Inserts to tool_impressions table. Logs to events table.",
        "vendor_value": "Shows visibility and competitive positioning"
      },
      {
        "name": "track_report_sent",
        "purpose": "CONVERSION EVENT - Track email report sent",
        "frontend_caller": "analytics.trackReportSent()",
        "frontend_files": [
          "src/ppm-tool/shared/hooks/useEmailReport.ts (line 184)"
        ],
        "parameters": [
          "p_email: TEXT",
          "p_first_name: TEXT",
          "p_last_name: TEXT",
          "p_tools: JSONB",
          "p_criteria: JSONB",
          "p_match_scores: JSONB",
          "p_firmographics: JSONB"
        ],
        "behavior": "Updates session with contact info and final match scores. Sets has_sent_report=true.",
        "data_captured": {
          "email": "Contact information for lead generation",
          "match_scores": "Final tool rankings and scores",
          "firmographics": "Complete company profile"
        }
      },
      {
        "name": "get_session_data",
        "purpose": "Helper for LLM export - Returns complete session as single JSON blob",
        "frontend_caller": "analytics.getSessionData()",
        "returns": "JSONB containing session + all events + all clicks + all impressions",
        "use_case": "Export for LLM analysis or data quality testing"
      }
    ]
  },
  "frontend_integration": {
    "overview": "Purely additive tracking - zero disruption to existing UI/functionality",
    "files_modified": [
      {
        "file": "src/lib/analytics.ts",
        "status": "NEW FILE",
        "purpose": "Central analytics service with fire-and-forget tracking",
        "key_exports": [
          "getAnalyticsSessionId(): string",
          "analytics.trackPageView()",
          "analytics.trackCriteriaRanking()",
          "analytics.trackGuidedRankingAnswer()",
          "analytics.trackToolClick()",
          "analytics.trackToolImpression()",
          "analytics.trackReportSent()",
          "analytics.getSessionData()"
        ],
        "error_handling": "All tracking wrapped in try/catch. Tracking failures never break UI."
      },
      {
        "file": "src/app/ppm-tool/page.tsx",
        "changes": [
          "Added analytics import (line 13)",
          "Added useEffect to track page view on mount (lines 27-36)"
        ],
        "risk": "None - runs once on mount, doesn't affect existing state"
      },
      {
        "file": "src/ppm-tool/features/criteria/components/CriteriaSection.tsx",
        "changes": [
          "Added analytics import (line 18)",
          "Added tracking call in sliderCallbacks (lines 128-134)"
        ],
        "risk": "None - fire-and-forget after existing logic"
      },
      {
        "file": "src/ppm-tool/components/forms/GuidedRankingForm.tsx",
        "changes": [
          "Added analytics import (line 14)",
          "Added tracking calls in handleSubmit (lines 679-705)"
        ],
        "risk": "None - tracking happens after form submission completes"
      },
      {
        "file": "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx",
        "changes": [
          "Added analytics import (line 19)",
          "Added tracking to Try Free button onClick (lines 306-319)",
          "Added tracking to Add to Compare button onClick (lines 332-345)",
          "Added tracking to View Details accordion onClick (lines 370-382)"
        ],
        "risk": "None - tracking added alongside existing onClick handlers"
      },
      {
        "file": "src/ppm-tool/shared/hooks/useEmailReport.ts",
        "changes": [
          "Added analytics import (line 7)",
          "Added comprehensive tracking in sendEmailReport (lines 158-196)"
        ],
        "risk": "None - tracking after successful email send, wrapped in try/catch"
      }
    ],
    "session_management": {
      "session_id": "UUID stored in localStorage as 'analytics_session_id'",
      "persistence": "Survives page reloads, cleared on browser cache clear",
      "deduplication": "Best-effort via IP address (95% accuracy expected)",
      "cross_device": "Not supported - each device gets new session"
    }
  },
  "data_flow": {
    "user_journey": [
      {
        "step": 1,
        "action": "User lands on /ppm-tool",
        "tracking": "track_page_view creates session",
        "data_captured": {
          "session_id": "Generated and stored in localStorage",
          "ip_address": "For deduplication",
          "referrer": "Where they came from",
          "utm_params": "Campaign tracking"
        }
      },
      {
        "step": 2,
        "action": "User moves criteria sliders",
        "tracking": "track_criteria_ranking on each change",
        "data_captured": {
          "criteria_rankings": "Real-time JSONB updates",
          "has_manual_ranking": "Set to true"
        }
      },
      {
        "step": 3,
        "action": "User completes guided ranking",
        "tracking": "track_guided_ranking_answer for each question",
        "data_captured": {
          "guided_ranking_answers": "All questions with timestamps",
          "firmographics": "Extracted from Q11, Q12, Q10",
          "has_partial_ranking": "Set to true",
          "has_full_ranking": "Set to true when complete"
        }
      },
      {
        "step": 4,
        "action": "User views tool recommendations",
        "tracking": "track_tool_impression for each tool shown",
        "data_captured": {
          "tool_impressions": "Position, score, competing tools",
          "match_breakdown": "Detailed criteria scores"
        }
      },
      {
        "step": 5,
        "action": "User clicks Try Free / Add to Compare / View Details",
        "tracking": "track_tool_click (MONETIZATION KEY)",
        "data_captured": {
          "tools_clicked": "Incremented counter per tool per action",
          "tool_clicks": "Full click log with context",
          "context": "Criteria rankings, match score, position"
        }
      },
      {
        "step": 6,
        "action": "User sends email report",
        "tracking": "track_report_sent (CONVERSION)",
        "data_captured": {
          "email": "Contact information",
          "first_name": "Lead data",
          "last_name": "Lead data",
          "match_scores": "Final tool rankings",
          "firmographics": "Complete company profile",
          "has_sent_report": "Set to true"
        }
      }
    ]
  },
  "monetization_insights": {
    "vendor_intelligence_product": "What software companies will pay for",
    "key_metrics": [
      {
        "metric": "Try Free Clicks",
        "value": "Highest intent action - user wants to use the tool",
        "price": "Premium - direct lead generation",
        "query": "SELECT tool_id, COUNT(*) as try_free_clicks FROM analytics.tool_clicks WHERE action_type = 'try_free' GROUP BY tool_id ORDER BY try_free_clicks DESC;"
      },
      {
        "metric": "Add to Compare",
        "value": "Active evaluation - user is comparing options",
        "price": "High - competitive intelligence",
        "query": "SELECT tool_id, COUNT(*) as compare_clicks FROM analytics.tool_clicks WHERE action_type = 'add_to_compare' GROUP BY tool_id;"
      },
      {
        "metric": "Buyer Intent Score",
        "value": "Composite score based on actions + firmographics + match score",
        "components": [
          "Try Free = 10 points",
          "Add to Compare = 5 points",
          "View Details = 2 points",
          "High match score (>8) = 3 points",
          "Enterprise firmographics = 5 points"
        ],
        "price": "Premium - qualified leads"
      },
      {
        "metric": "Feature Gap Analysis",
        "value": "Where tools fall short of user requirements",
        "data_source": "match_breakdown + criteria_rankings",
        "price": "High - product roadmap insights",
        "example": "Users want Scalability=5 but Tool X only has 3 - common gap"
      },
      {
        "metric": "Competitive Intelligence",
        "value": "Which tools are losing to competitors",
        "data_source": "tool_comparisons + tool_impressions",
        "price": "Medium - market positioning",
        "example": "Tool X shown in position 3, but users click Tool Y in position 1"
      },
      {
        "metric": "Firmographics + Intent",
        "value": "Company profile + high-intent actions = qualified leads",
        "data_source": "firmographics + tool_clicks",
        "price": "Premium - warm leads with context",
        "example": "Enterprise company (>500 employees) clicked Try Free for Tool X"
      }
    ]
  },
  "llm_integration": {
    "overview": "JSON-first design makes data easily parsable by LLMs for quality testing and analysis",
    "use_cases": [
      {
        "use_case": "Data Quality Testing",
        "method": "Export session data, feed to LLM, ask 'Does this look like real user behavior?'",
        "function": "get_session_data(session_id)",
        "llm_prompt": "Analyze this user session data and identify any anomalies, bot-like behavior, or data quality issues."
      },
      {
        "use_case": "Lead Scoring",
        "method": "Feed firmographics + tool clicks to LLM for intelligent scoring",
        "llm_prompt": "Given this user's company profile and tool interactions, score their likelihood to purchase (0-100) and explain why."
      },
      {
        "use_case": "Product Insights",
        "method": "Aggregate criteria rankings + feature gaps, feed to LLM",
        "llm_prompt": "Based on user requirements and tool ratings, what features should we prioritize for Tool X?"
      },
      {
        "use_case": "Competitive Analysis",
        "method": "Feed tool comparisons + impressions to LLM",
        "llm_prompt": "Analyze competitive positioning: which tools are winning and why?"
      }
    ],
    "sample_query": "SELECT jsonb_build_object('session', row_to_json(vs.*), 'events', (SELECT jsonb_agg(row_to_json(e.*)) FROM analytics.events e WHERE e.session_id = vs.session_id)) FROM analytics.visitor_sessions vs WHERE vs.session_id = 'abc-123';"
  },
  "querying_examples": {
    "funnel_analysis": "SELECT SUM(CASE WHEN is_active THEN 1 ELSE 0 END) as active, SUM(CASE WHEN has_manual_ranking THEN 1 ELSE 0 END) as manual_ranking, SUM(CASE WHEN has_partial_ranking THEN 1 ELSE 0 END) as partial_ranking, SUM(CASE WHEN has_full_ranking THEN 1 ELSE 0 END) as full_ranking, SUM(CASE WHEN has_sent_report THEN 1 ELSE 0 END) as sent_report FROM analytics.visitor_sessions;",
    "top_clicked_tools": "SELECT t.name, tc.action_type, COUNT(*) as clicks FROM analytics.tool_clicks tc JOIN public.tools t ON tc.tool_id = t.id WHERE tc.created_at > NOW() - INTERVAL '30 days' GROUP BY t.name, tc.action_type ORDER BY clicks DESC;",
    "high_intent_leads": "SELECT vs.email, vs.firmographics, vs.tools_clicked FROM analytics.visitor_sessions vs WHERE vs.has_sent_report = true AND vs.tools_clicked::jsonb ? 'try_free' AND vs.created_at > NOW() - INTERVAL '7 days';",
    "criteria_popularity": "SELECT key as criteria_id, COUNT(*) as usage_count, AVG((value)::int) as avg_score FROM analytics.visitor_sessions, jsonb_each(criteria_rankings) WHERE has_manual_ranking = true GROUP BY key ORDER BY usage_count DESC;",
    "guided_ranking_completion_rate": "SELECT COUNT(CASE WHEN has_partial_ranking THEN 1 END)::float / NULLIF(COUNT(*), 0) * 100 as partial_rate, COUNT(CASE WHEN has_full_ranking THEN 1 END)::float / NULLIF(COUNT(*), 0) * 100 as full_rate FROM analytics.visitor_sessions WHERE is_active = true;"
  },
  "security": {
    "rls_policies": "No RLS policies on analytics tables - all access via SECURITY DEFINER functions",
    "api_access": "No direct table access from frontend - only RPC functions",
    "pii_handling": "Email stored only after explicit consent (report sent)",
    "data_retention": "No automatic deletion - manual cleanup or future policy",
    "vendor_access": "Future: Vendor dashboard with filtered views, no raw table access"
  },
  "future_enhancements": [
    "Vendor dashboard for self-service insights",
    "API access for vendors to pull their data programmatically",
    "Automated lead scoring with LLM integration",
    "Real-time alerts for high-intent actions (Try Free clicks)",
    "A/B testing framework with analytics integration",
    "Cohort analysis for retention tracking",
    "pg_cron jobs for nightly aggregations (vendor_intelligence tables)",
    "Data export to CSV/JSON for offline analysis",
    "Integration with CRM (HubSpot, Salesforce)",
    "Heatmap tracking for UI optimization"
  ],
  "testing_verification": {
    "manual_testing": [
      "1. Load /ppm-tool and check localStorage for analytics_session_id",
      "2. Move criteria sliders and verify criteria_rankings updates in Supabase",
      "3. Complete guided ranking and verify guided_ranking_answers",
      "4. Click Try Free and verify tool_clicks table has new row",
      "5. Send email report and verify has_sent_report=true with email populated"
    ],
    "sql_verification": [
      "SELECT COUNT(*) FROM analytics.visitor_sessions; -- Should have entries",
      "SELECT COUNT(*) FROM analytics.events; -- Should have many entries",
      "SELECT COUNT(*) FROM analytics.tool_clicks WHERE action_type = 'try_free'; -- Should have clicks",
      "SELECT criteria_rankings FROM analytics.visitor_sessions WHERE session_id = 'YOUR_SESSION_ID'; -- Verify JSON structure",
      "SELECT * FROM analytics.visitor_sessions ORDER BY created_at DESC LIMIT 10; -- Recent sessions"
    ],
    "llm_data_quality_test": "Call get_session_data(session_id) and feed result to ChatGPT/Claude with prompt: 'Does this user session data look realistic and complete? Identify any issues.'"
  }
}

