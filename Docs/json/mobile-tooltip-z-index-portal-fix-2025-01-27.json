{
  "schema_version": "1.0.0",
  "last_updated": "2025-01-27T22:30:00Z",
  "type": "FIX",
  "metadata": {
    "project": "Panoramic Solutions - PPM Tool Finder",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true
  },
  "fix_summary": {
    "title": "Mobile Tooltip Appearing Behind Cards - Portal & Z-Index Fix",
    "date": "2025-01-27",
    "severity": "CRITICAL",
    "status": "RESOLVED",
    "description": "Mobile tooltips were rendering behind tool cards instead of as an overlay on top. When cards expanded, the tooltip would drop down even further behind content. The tooltip needed to be an overlay in front of everything."
  },
  "visual_evidence": {
    "problem_screenshot_1": "Tooltip appears behind expanded card content",
    "problem_screenshot_2": "Tooltip partially visible but obscured by card",
    "issue": "Dark tooltip box visible behind white card background"
  },
  "root_cause": {
    "primary_issue": "Tooltip rendered within card's DOM hierarchy and stacking context",
    "details": [
      "MobileTooltip was rendering the tooltip div as a sibling to the trigger element",
      "Even with z-index: 9999, the tooltip was constrained by parent stacking contexts",
      "Card components create new stacking contexts, preventing z-index from working globally",
      "When cards expand, their content pushes down, and the tooltip (being a child) moves with it"
    ],
    "affected_components": [
      "src/ppm-tool/components/ui/MobileTooltip.tsx",
      "src/ppm-tool/components/ui/MatchScoreTooltip.tsx"
    ],
    "stacking_context_issue": "CSS z-index only works within the same stacking context. Cards with position/opacity/transform create new contexts, trapping child elements."
  },
  "solution": {
    "approach": "React Portal + High Z-Index + StopPropagation Wrapper",
    "implementation": [
      "Use React.createPortal to render tooltip directly to document.body",
      "This escapes the card's DOM hierarchy and stacking context entirely",
      "Add stopPropagation wrapper to prevent card expansion on click",
      "Increase z-index values to ensure tooltip is always on top"
    ],
    "why_portal_works": "React Portal renders the tooltip as a direct child of document.body, completely outside the card's DOM tree. This means no parent stacking contexts can interfere with the tooltip's z-index.",
    "code_changes": [
      {
        "file": "src/ppm-tool/components/ui/MobileTooltip.tsx",
        "changes": [
          "Added import: import { createPortal } from 'react-dom'",
          "Wrapped tooltip div with createPortal(tooltipElement, document.body)",
          "Added typeof document !== 'undefined' check for SSR compatibility",
          "Applied to both isTouchDevice and hasTouch rendering branches"
        ],
        "line_numbers": "230-242, 269-281"
      },
      {
        "file": "src/ppm-tool/components/ui/MatchScoreTooltip.tsx",
        "changes": [
          "Wrapped MobileTooltip in div with onClick={(e) => e.stopPropagation()}",
          "Added z-[100] to wrapper for local stacking",
          "Added !z-[9999] to MobileTooltip className for tooltip override",
          "Updated trigger div z-index from z-10 to z-[100]"
        ],
        "line_numbers": "81-99"
      }
    ]
  },
  "technical_details": {
    "react_portal": {
      "what": "React feature that renders children into a DOM node outside the parent component hierarchy",
      "syntax": "createPortal(child, container)",
      "use_case": "Tooltips, modals, popovers - anything that needs to escape parent constraints",
      "ssr_safety": "Wrap in typeof document !== 'undefined' check"
    },
    "stacking_context": {
      "created_by": [
        "position: relative/absolute/fixed with z-index",
        "opacity < 1",
        "transform",
        "filter",
        "will-change"
      ],
      "problem": "z-index only compares elements within the same stacking context",
      "solution": "Move element to document.body via portal (top-level stacking context)"
    },
    "z_index_values": {
      "wrapper_div": "z-[100] - Local stacking for trigger element",
      "tooltip": "z-[9999] - Maximum stacking to appear above everything",
      "important_prefix": "!z-[9999] - Tailwind ! prefix to override any conflicting classes"
    }
  },
  "testing": {
    "test_scenarios": [
      {
        "scenario": "Mobile - condensed card - tooltip click",
        "device": "iPhone",
        "steps": [
          "Tap 'N/A Match Score' on condensed card",
          "Tooltip should appear as overlay on top of all content",
          "Tooltip should be fully visible, not obscured"
        ],
        "expected": "✅ Tooltip renders as overlay above cards"
      },
      {
        "scenario": "Mobile - expanded card - tooltip click",
        "device": "iPhone",
        "steps": [
          "Expand a card to show criteria details",
          "Tap 'N/A Match Score'",
          "Tooltip should appear above expanded content"
        ],
        "expected": "✅ Tooltip remains on top, doesn't drop behind content"
      },
      {
        "scenario": "Multiple cards expanded",
        "device": "iPhone",
        "steps": [
          "Scroll through list",
          "Tap tooltip on any card",
          "Verify tooltip appears above all cards"
        ],
        "expected": "✅ Tooltip always renders on top regardless of card state"
      },
      {
        "scenario": "Tooltip positioning",
        "device": "iPhone",
        "steps": [
          "Tap tooltip near top of screen",
          "Verify tooltip appears below trigger (side='bottom')",
          "Check viewport boundary handling"
        ],
        "expected": "✅ Tooltip positioned correctly with viewport collision detection"
      }
    ]
  },
  "before_after": {
    "before": {
      "rendering": "Tooltip rendered as sibling to trigger within card DOM",
      "z_index": "z-[9999] but trapped in card's stacking context",
      "result": "Tooltip appears behind card content",
      "user_experience": "Tooltip unusable - can't read text behind cards"
    },
    "after": {
      "rendering": "Tooltip rendered via portal to document.body",
      "z_index": "z-[9999] in top-level stacking context",
      "result": "Tooltip appears as overlay above all content",
      "user_experience": "Tooltip fully visible and readable on all devices"
    }
  },
  "related_fixes": {
    "stopPropagation": "Added onClick={(e) => e.stopPropagation()} wrapper to prevent card expansion when clicking tooltip",
    "ssr_safety": "Added typeof document !== 'undefined' check for Next.js SSR compatibility",
    "touch_devices": "Applied portal fix to both isTouchDevice and hasTouch branches"
  },
  "verification_checklist": [
    "✅ Tooltip appears above all cards on mobile",
    "✅ Tooltip doesn't cause card to expand when clicked",
    "✅ Tooltip positioning correct (below trigger)",
    "✅ Tooltip closes when tapping outside",
    "✅ No SSR errors (document check works)",
    "✅ Desktop hover tooltips still work",
    "✅ Touchscreen laptop hybrid mode works"
  ],
  "common_portal_use_cases": [
    "Tooltips (this fix)",
    "Modal dialogs",
    "Dropdown menus",
    "Toast notifications",
    "Context menus",
    "Popovers"
  ],
  "deployment_notes": {
    "breaking_changes": false,
    "requires_testing": true,
    "test_on_actual_devices": "CRITICAL - Must test on real iPhone/Android",
    "rollback_plan": "Revert createPortal changes, tooltip will go behind cards again",
    "monitoring": "Watch for SSR errors, positioning issues, or z-index conflicts"
  },
  "lessons_learned": {
    "z_index_alone_insufficient": "High z-index doesn't work across stacking contexts",
    "portals_are_essential": "For overlays, always use React Portal to escape parent DOM",
    "test_in_context": "Isolated component tests don't reveal stacking context issues",
    "ssr_considerations": "Always check typeof document when using browser APIs"
  }
}

