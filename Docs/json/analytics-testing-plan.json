{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-09T00:15:00Z",
  "type": "TESTING",
  "metadata": {
    "project": "Panoramic Solutions - PPM Tool",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true,
    "description": "Comprehensive testing plan for new analytics system"
  },
  "testing_overview": {
    "purpose": "Verify end-to-end data flow from user interaction to database storage",
    "test_types": [
      "Database Function Testing (SQL)",
      "Frontend Integration Testing (Manual)",
      "Data Verification Testing (SQL Queries)",
      "Rollup View Testing (SQL Queries)"
    ],
    "estimated_time": "30-45 minutes for complete test suite"
  },
  "test_suite_1_database_functions": {
    "description": "Test Supabase RPC functions directly to verify business logic",
    "prerequisite": "Access to Supabase SQL Editor or MCP Supabase tools",
    "tests": [
      {
        "test_id": "DB-01",
        "name": "User Record Creation",
        "sql": "SELECT ensure_analytics_user(\n  'test_session_' || NOW()::text,\n  '192.168.1.100'::inet,\n  'Mozilla/5.0 (Test Browser)',\n  'https://google.com',\n  'google',\n  'cpc',\n  'test_campaign',\n  NULL,\n  NULL,\n  NULL\n) as new_user_id;",
        "expected_result": "Returns a UUID (user_id)",
        "verification": "SELECT * FROM analytics.users WHERE session_id LIKE 'test_session_%' ORDER BY first_seen_at DESC LIMIT 1;",
        "success_criteria": [
          "user_id is valid UUID",
          "session_id matches input",
          "ip_address = 192.168.1.100",
          "utm_source = 'google'",
          "page_view_count = 1"
        ]
      },
      {
        "test_id": "DB-02",
        "name": "Question Response Tracking",
        "setup": "Use session_id from DB-01",
        "sql": "SELECT track_question_response(\n  '{session_id_from_DB01}',\n  1,\n  '4'\n) as success;",
        "expected_result": "Returns true",
        "verification": "SELECT uqr.*, q.question_text, qc.choice_text\nFROM analytics.user_question_responses uqr\nJOIN analytics.users u ON uqr.user_id = u.user_id\nLEFT JOIN analytics.questions q ON uqr.question_order = q.question_order\nLEFT JOIN analytics.question_choices qc ON q.question_id = qc.question_id AND uqr.choice_value = qc.choice_value\nWHERE u.session_id = '{session_id_from_DB01}';",
        "success_criteria": [
          "Row exists in user_question_responses",
          "question_order = 1",
          "choice_value = '4'",
          "responded_at is recent timestamp"
        ]
      },
      {
        "test_id": "DB-03",
        "name": "Criteria Rating Tracking",
        "setup": "Use session_id from DB-01",
        "sql": "SELECT track_criteria_response(\n  '{session_id_from_DB01}',\n  'ease_of_use',\n  'Ease of Use',\n  8,\n  true\n) as success;",
        "expected_result": "Returns true",
        "verification": "SELECT * FROM analytics.user_criteria_responses\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{session_id_from_DB01}')\nORDER BY rated_at DESC;",
        "success_criteria": [
          "Row exists with criteria_id = 'ease_of_use'",
          "score = 8",
          "is_manual = true"
        ]
      },
      {
        "test_id": "DB-04",
        "name": "Tool Action Tracking - View Details",
        "setup": "Use session_id from DB-01",
        "sql": "SELECT track_tool_action(\n  '{session_id_from_DB01}',\n  'smartsheet',\n  'Smartsheet',\n  'view_details',\n  1,\n  9.2,\n  '{\"criteria_adjusted\": true, \"expanding\": true}'::jsonb\n) as success;",
        "expected_result": "Returns true",
        "verification": "SELECT * FROM analytics.user_tool_actions\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{session_id_from_DB01}')\nORDER BY action_timestamp DESC;",
        "success_criteria": [
          "action_type = 'view_details'",
          "position = 1",
          "match_score = 9.2",
          "context_data contains criteria_adjusted and expanding keys"
        ]
      },
      {
        "test_id": "DB-05",
        "name": "Tool Action Tracking - Try Free",
        "setup": "Use session_id from DB-01",
        "sql": "SELECT track_tool_action(\n  '{session_id_from_DB01}',\n  'smartsheet',\n  'Smartsheet',\n  'try_free',\n  1,\n  9.2,\n  '{\"criteria_adjusted\": true}'::jsonb\n) as success;",
        "expected_result": "Returns true",
        "verification": "SELECT action_type, tool_name, position, match_score\nFROM analytics.user_tool_actions\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{session_id_from_DB01}')\n  AND action_type = 'try_free';",
        "success_criteria": [
          "action_type = 'try_free' row exists",
          "This is a high-value action for monetization tracking"
        ]
      },
      {
        "test_id": "DB-06",
        "name": "Recommendation Tracking",
        "setup": "Use session_id from DB-01, update user with email first",
        "sql": "-- First update user with email\nSELECT ensure_analytics_user(\n  '{session_id_from_DB01}',\n  '192.168.1.100'::inet,\n  'Mozilla/5.0 (Test Browser)',\n  NULL,\n  NULL,\n  NULL,\n  NULL,\n  'test@example.com',\n  'Test',\n  'User'\n);\n\n-- Then track recommendation\nSELECT track_recommendation_sent(\n  '{session_id_from_DB01}',\n  'recipient@example.com',\n  'John',\n  'Doe',\n  '{\"tools\": [\"Smartsheet\", \"Asana\"], \"criteria\": {\"ease_of_use\": 8}}'::jsonb\n) as recommendation_id;",
        "expected_result": "Returns a UUID (recommendation_id)",
        "verification": "SELECT r.*, u.email as sender_email\nFROM analytics.recommendations r\nJOIN analytics.users u ON r.user_id = u.user_id\nWHERE u.session_id = '{session_id_from_DB01}';",
        "success_criteria": [
          "recommendation_id is valid UUID",
          "recipient_email = 'recipient@example.com'",
          "report_data contains tools and criteria",
          "sent_at is recent timestamp"
        ]
      },
      {
        "test_id": "DB-07",
        "name": "Get User Analytics - Full Retrieval",
        "setup": "Use session_id from DB-01 after all previous tests",
        "sql": "SELECT get_user_analytics('{session_id_from_DB01}');",
        "expected_result": "Returns JSONB with complete user analytics",
        "success_criteria": [
          "question_responses array has 1 item",
          "criteria_responses array has 1+ items",
          "tool_actions array has 2+ items (view_details + try_free)",
          "recommendations array has 1 item",
          "All data properly joined and formatted"
        ]
      }
    ]
  },
  "test_suite_2_frontend_integration": {
    "description": "Manual testing of frontend user interactions",
    "prerequisite": "Development server running, browser console open",
    "setup_steps": [
      "1. Open browser DevTools (F12)",
      "2. Go to Console tab",
      "3. Clear localStorage: localStorage.clear()",
      "4. Navigate to PPM tool in browser",
      "5. Open Network tab to monitor Supabase RPC calls"
    ],
    "tests": [
      {
        "test_id": "FE-01",
        "name": "Initial User Tracking",
        "steps": [
          "1. Load the PPM tool page",
          "2. Check browser console for 'Analytics initialized' message",
          "3. In Network tab, look for 'rest/v1/rpc/ensure_analytics_user' call",
          "4. Verify response has user_id"
        ],
        "browser_console_check": "localStorage.getItem('ppm_session_id')",
        "expected": "Session ID stored in localStorage",
        "database_verification": "SELECT * FROM analytics.users WHERE session_id = '{from_localStorage}' ORDER BY first_seen_at DESC LIMIT 1;",
        "success_criteria": [
          "User record created in database",
          "session_id matches localStorage",
          "page_view_count = 1"
        ]
      },
      {
        "test_id": "FE-02",
        "name": "Guided Ranking Answer Tracking",
        "steps": [
          "1. Navigate to Guided Rankings section",
          "2. Answer Question 1 (select any option)",
          "3. Check Network tab for 'rest/v1/rpc/track_question_response'",
          "4. Verify response shows success: true"
        ],
        "database_verification": "SELECT uqr.*, q.question_text, qc.choice_text\nFROM analytics.user_question_responses uqr\nJOIN analytics.users u ON uqr.user_id = u.user_id\nLEFT JOIN analytics.questions q ON uqr.question_order = q.question_order\nLEFT JOIN analytics.question_choices qc ON q.question_id = qc.question_id AND uqr.choice_value = qc.choice_value\nWHERE u.session_id = '{from_localStorage}'\nORDER BY uqr.responded_at DESC;",
        "success_criteria": [
          "Question response stored immediately",
          "question_order and choice_value correct",
          "responded_at timestamp is recent"
        ]
      },
      {
        "test_id": "FE-03",
        "name": "Criteria Slider Tracking",
        "steps": [
          "1. Navigate to Criteria section",
          "2. Move any criteria slider",
          "3. Check Network tab for 'rest/v1/rpc/track_criteria_response'",
          "4. Check console for analytics tracking confirmation"
        ],
        "database_verification": "SELECT criteria_name, score, is_manual, rated_at\nFROM analytics.user_criteria_responses\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{from_localStorage}')\nORDER BY rated_at DESC;",
        "success_criteria": [
          "Criteria response stored with correct score",
          "is_manual = true (user adjusted)",
          "rated_at timestamp is recent"
        ]
      },
      {
        "test_id": "FE-04",
        "name": "Tool View Details Tracking",
        "steps": [
          "1. Scroll to Tools & Recommendations section",
          "2. Click 'View Details' on first tool",
          "3. Check Network tab for 'rest/v1/rpc/track_tool_action'",
          "4. Verify action_type is 'view_details' in request payload"
        ],
        "database_verification": "SELECT tool_name, action_type, position, match_score, context_data, action_timestamp\nFROM analytics.user_tool_actions\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{from_localStorage}')\n  AND action_type = 'view_details'\nORDER BY action_timestamp DESC;",
        "success_criteria": [
          "Tool action stored with action_type = 'view_details'",
          "position = 1 (first tool in results)",
          "match_score reflects actual match score",
          "context_data has expanding = true"
        ]
      },
      {
        "test_id": "FE-05",
        "name": "Tool Compare Tracking",
        "steps": [
          "1. Click 'Compare' button on a tool",
          "2. Check Network tab for RPC call",
          "3. Check PostHog network call also fires (dual tracking)"
        ],
        "database_verification": "SELECT tool_name, action_type, position, action_timestamp\nFROM analytics.user_tool_actions\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{from_localStorage}')\n  AND action_type = 'add_to_compare';",
        "success_criteria": [
          "action_type = 'add_to_compare'",
          "Both Supabase and PostHog tracked"
        ]
      },
      {
        "test_id": "FE-06",
        "name": "Tool Try Free Tracking",
        "steps": [
          "1. Click 'Try Free' button on a tool with trial",
          "2. Check Network tab for RPC call",
          "3. Check PostHog network call also fires",
          "4. Verify link opens in new tab"
        ],
        "database_verification": "SELECT tool_name, action_type, position, match_score\nFROM analytics.user_tool_actions\nWHERE user_id = (SELECT user_id FROM analytics.users WHERE session_id = '{from_localStorage}')\n  AND action_type = 'try_free';",
        "success_criteria": [
          "action_type = 'try_free'",
          "High-value conversion event tracked",
          "Both analytics systems received event"
        ]
      },
      {
        "test_id": "FE-07",
        "name": "Email Report Tracking",
        "steps": [
          "1. Click 'Get Your Report' button",
          "2. Fill in First Name, Last Name, Email",
          "3. Click 'Send My Free Report'",
          "4. Check Network tab for 'rest/v1/rpc/track_recommendation_sent'"
        ],
        "database_verification": "SELECT r.recommendation_id, r.recipient_email, r.sent_at, u.first_name, u.last_name\nFROM analytics.recommendations r\nJOIN analytics.users u ON r.user_id = u.user_id\nWHERE u.session_id = '{from_localStorage}';",
        "success_criteria": [
          "Recommendation record created",
          "User record updated with email/name",
          "report_data JSONB contains guided ranking answers and tool selections"
        ]
      },
      {
        "test_id": "FE-08",
        "name": "User Data Persistence - Return Visit",
        "steps": [
          "1. After completing FE-01 through FE-07, refresh the page",
          "2. Navigate to Guided Rankings",
          "3. Verify previous answers are pre-filled",
          "4. Check Network tab for 'rest/v1/rpc/get_user_analytics' call"
        ],
        "browser_console_check": "// Check that answers loaded from database\nconst sessionId = localStorage.getItem('ppm_session_id');\nconsole.log('Session ID:', sessionId);",
        "success_criteria": [
          "get_user_analytics() called on form mount",
          "Previous answers displayed in form",
          "User can continue from where they left off"
        ]
      }
    ]
  },
  "test_suite_3_rollup_views": {
    "description": "Verify aggregated analytics views update correctly",
    "tests": [
      {
        "test_id": "ROLLUP-01",
        "name": "User Activity Rollup Accuracy",
        "sql": "SELECT \n  session_id,\n  questions_answered,\n  criteria_rated,\n  tools_interacted_with,\n  total_tool_actions,\n  has_recommendations\nFROM analytics.user_activity_rollups\nWHERE session_id = '{test_session_id}';",
        "manual_verification": "Compare counts to actual junction table rows",
        "success_criteria": [
          "questions_answered = COUNT from user_question_responses",
          "criteria_rated = COUNT from user_criteria_responses",
          "tools_interacted_with = COUNT DISTINCT tool_id from user_tool_actions",
          "total_tool_actions = COUNT from user_tool_actions",
          "has_recommendations = true if recommendations exist"
        ]
      },
      {
        "test_id": "ROLLUP-02",
        "name": "Tool Action Rollup Accuracy",
        "sql": "SELECT \n  tool_name,\n  total_actions,\n  unique_users,\n  total_clicks,\n  total_views,\n  total_compares,\n  total_try_frees,\n  avg_match_score,\n  avg_position\nFROM analytics.tool_action_rollups\nWHERE tool_name = 'Smartsheet';",
        "success_criteria": [
          "total_actions = SUM of all action types",
          "unique_users = COUNT DISTINCT user_id",
          "Action type counts match filtered queries",
          "avg_match_score is reasonable (0-10 range)",
          "avg_position reflects tool's typical ranking"
        ]
      },
      {
        "test_id": "ROLLUP-03",
        "name": "Question Response Rollup",
        "sql": "SELECT \n  question_order,\n  total_responses,\n  unique_users_answered,\n  most_common_choice\nFROM analytics.question_response_rollups\nORDER BY question_order;",
        "success_criteria": [
          "Each question has rollup data",
          "most_common_choice shows popular answers",
          "Useful for A/B testing and guided ranking analysis"
        ]
      }
    ]
  },
  "test_suite_4_edge_cases": {
    "description": "Test edge cases and error handling",
    "tests": [
      {
        "test_id": "EDGE-01",
        "name": "Duplicate Question Response",
        "scenario": "User answers same question twice (changes mind)",
        "steps": [
          "Answer Question 1 with choice 'A'",
          "Answer Question 1 again with choice 'B'"
        ],
        "expected_behavior": "Latest answer overwrites previous (ON CONFLICT DO UPDATE)",
        "verification": "SELECT choice_value, responded_at FROM analytics.user_question_responses WHERE user_id = '{user_id}' AND question_order = 1;",
        "success_criteria": [
          "Only 1 row exists for question_order = 1",
          "choice_value = 'B' (latest)",
          "responded_at updated to latest timestamp"
        ]
      },
      {
        "test_id": "EDGE-02",
        "name": "Missing Session ID",
        "scenario": "analytics.trackToolClick() called with no session_id",
        "expected_behavior": "Function generates new session_id",
        "verification": "Check browser console for session ID generation message",
        "success_criteria": [
          "Error doesn't crash UI",
          "New session_id created and stored",
          "Event tracked under new session"
        ]
      },
      {
        "test_id": "EDGE-03",
        "name": "RPC Function Failure",
        "scenario": "Supabase connection drops during tracking",
        "expected_behavior": "Error logged to console, UI continues working",
        "verification": "Try-catch blocks prevent UI breakage",
        "success_criteria": [
          "Console shows 'Failed to track...' warning",
          "User can continue using app",
          "Analytics service degrades gracefully"
        ]
      },
      {
        "test_id": "EDGE-04",
        "name": "Anonymous User (No Email)",
        "scenario": "User interacts but never provides email",
        "expected_behavior": "All tracking works, email fields remain NULL",
        "verification": "SELECT email, first_name, last_name FROM analytics.users WHERE session_id = '{session_id}';",
        "success_criteria": [
          "email, first_name, last_name are NULL",
          "All other tracking (questions, criteria, tools) still works",
          "User can be identified by session_id alone"
        ]
      }
    ]
  },
  "comprehensive_verification_query": {
    "description": "Single query to see complete user journey",
    "sql": "WITH user_info AS (\n  SELECT user_id, session_id, email, first_name, last_name, first_seen_at\n  FROM analytics.users\n  WHERE session_id = '{test_session_id}'\n),\nquestions AS (\n  SELECT COUNT(*) as questions_answered\n  FROM analytics.user_question_responses uqr\n  WHERE uqr.user_id = (SELECT user_id FROM user_info)\n),\ncriteria AS (\n  SELECT COUNT(*) as criteria_rated, AVG(score) as avg_criteria_score\n  FROM analytics.user_criteria_responses ucr\n  WHERE ucr.user_id = (SELECT user_id FROM user_info)\n),\ntools AS (\n  SELECT \n    COUNT(*) as total_tool_actions,\n    COUNT(DISTINCT tool_id) as unique_tools_interacted,\n    COUNT(CASE WHEN action_type = 'try_free' THEN 1 END) as try_free_clicks\n  FROM analytics.user_tool_actions uta\n  WHERE uta.user_id = (SELECT user_id FROM user_info)\n),\nrecs AS (\n  SELECT COUNT(*) as recommendations_sent\n  FROM analytics.recommendations r\n  WHERE r.user_id = (SELECT user_id FROM user_info)\n)\nSELECT \n  ui.*,\n  q.questions_answered,\n  c.criteria_rated,\n  c.avg_criteria_score,\n  t.total_tool_actions,\n  t.unique_tools_interacted,\n  t.try_free_clicks,\n  r.recommendations_sent,\n  CASE \n    WHEN r.recommendations_sent > 0 THEN 'CONVERTED'\n    WHEN t.try_free_clicks > 0 THEN 'HIGH_INTENT'\n    WHEN t.total_tool_actions > 0 THEN 'ENGAGED'\n    WHEN q.questions_answered > 0 THEN 'ACTIVE'\n    ELSE 'VISITOR'\n  END as user_engagement_level\nFROM user_info ui\nCROSS JOIN questions q\nCROSS JOIN criteria c\nCROSS JOIN tools t\nCROSS JOIN recs r;",
    "purpose": "Single comprehensive view of user's complete analytics journey"
  },
  "automated_test_script": {
    "description": "Complete automated test using session_id",
    "usage": "Replace {SESSION_ID} with actual test session",
    "steps": [
      {
        "step": 1,
        "action": "Create user",
        "sql": "SELECT ensure_analytics_user('auto_test_' || EXTRACT(EPOCH FROM NOW())::text, '192.168.1.1'::inet, 'Test Browser', NULL, 'test', 'automated', NULL, NULL, NULL, NULL) as user_id;"
      },
      {
        "step": 2,
        "action": "Track 3 question responses",
        "sql": "SELECT track_question_response('{SESSION_ID}', 1, '4');\nSELECT track_question_response('{SESSION_ID}', 2, '2');\nSELECT track_question_response('{SESSION_ID}', 3, '1');"
      },
      {
        "step": 3,
        "action": "Track 5 criteria ratings",
        "sql": "SELECT track_criteria_response('{SESSION_ID}', 'ease_of_use', 'Ease of Use', 8, true);\nSELECT track_criteria_response('{SESSION_ID}', 'collaboration', 'Collaboration', 7, true);\nSELECT track_criteria_response('{SESSION_ID}', 'reporting', 'Reporting', 9, true);\nSELECT track_criteria_response('{SESSION_ID}', 'pricing', 'Pricing', 6, false);\nSELECT track_criteria_response('{SESSION_ID}', 'integrations', 'Integrations', 8, true);"
      },
      {
        "step": 4,
        "action": "Track various tool actions",
        "sql": "SELECT track_tool_action('{SESSION_ID}', 'smartsheet', 'Smartsheet', 'view_details', 1, 9.2, '{\"criteria_adjusted\": true}'::jsonb);\nSELECT track_tool_action('{SESSION_ID}', 'smartsheet', 'Smartsheet', 'add_to_compare', 1, 9.2, '{}'::jsonb);\nSELECT track_tool_action('{SESSION_ID}', 'asana', 'Asana', 'view_details', 2, 8.7, '{\"criteria_adjusted\": true}'::jsonb);\nSELECT track_tool_action('{SESSION_ID}', 'smartsheet', 'Smartsheet', 'try_free', 1, 9.2, '{}'::jsonb);"
      },
      {
        "step": 5,
        "action": "Update user with email and send recommendation",
        "sql": "SELECT ensure_analytics_user('{SESSION_ID}', '192.168.1.1'::inet, 'Test Browser', NULL, NULL, NULL, NULL, 'autotest@example.com', 'Auto', 'Test');\nSELECT track_recommendation_sent('{SESSION_ID}', 'autotest@example.com', 'Auto', 'Test', '{\"test\": true}'::jsonb);"
      },
      {
        "step": 6,
        "action": "Verify complete user journey",
        "sql": "Use comprehensive_verification_query above with {SESSION_ID}"
      },
      {
        "step": 7,
        "action": "Cleanup test data",
        "sql": "DELETE FROM analytics.users WHERE session_id LIKE 'auto_test_%';"
      }
    ]
  },
  "success_metrics": {
    "database_health": [
      "All RPC functions return expected data types",
      "Foreign key constraints maintain referential integrity",
      "Rollup views aggregate correctly",
      "No orphaned records in junction tables"
    ],
    "frontend_integration": [
      "All user interactions trigger analytics calls",
      "Network tab shows successful RPC responses",
      "No console errors from analytics service",
      "User data persists across page refreshes"
    ],
    "data_quality": [
      "Timestamps are accurate and in correct timezone",
      "JSONB context_data fields are properly structured",
      "Action types match expected enum values",
      "Match scores and positions are within valid ranges"
    ]
  }
}


