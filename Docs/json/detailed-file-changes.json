{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-08T23:15:00Z",
  "type": "MIGRATION",
  "metadata": {
    "project": "PPM Tool Finder",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true,
    "purpose": "Detailed file-by-file changes required for new analytics schema implementation"
  },
  "files_requiring_changes": {
    "supabase_functions": {
      "file": "supabase/migrations/20251108_analytics_rpc_functions.sql",
      "status": "CREATE NEW",
      "priority": "CRITICAL",
      "description": "Create RPC functions for new relational analytics schema",
      "functions_to_create": [
        {
          "name": "ensure_analytics_user",
          "parameters": ["p_session_id TEXT", "p_ip_address INET", "p_user_agent TEXT", "p_referrer_url TEXT", "p_utm_source TEXT", "p_utm_medium TEXT", "p_utm_campaign TEXT"],
          "returns": "UUID",
          "purpose": "Create or update analytics.users record, return user_id"
        },
        {
          "name": "track_question_response", 
          "parameters": ["p_session_id TEXT", "p_question_id UUID", "p_question_choice_id UUID", "p_response_text TEXT"],
          "returns": "BOOLEAN",
          "purpose": "Insert/update user_question_responses junction table"
        },
        {
          "name": "track_criteria_response",
          "parameters": ["p_session_id TEXT", "p_criteria_id UUID", "p_rating INTEGER"],
          "returns": "BOOLEAN", 
          "purpose": "Insert/update user_criteria_responses junction table"
        },
        {
          "name": "track_tool_action",
          "parameters": ["p_session_id TEXT", "p_tool_id UUID", "p_action_type TEXT", "p_position INTEGER", "p_match_score NUMERIC", "p_context JSONB"],
          "returns": "BOOLEAN",
          "purpose": "Insert user_tool_actions junction table record"
        },
        {
          "name": "track_recommendation_sent",
          "parameters": ["p_session_id TEXT", "p_email TEXT", "p_first_name TEXT", "p_last_name TEXT", "p_recommended_tools JSONB", "p_match_scores JSONB", "p_criteria_weights JSONB"],
          "returns": "UUID",
          "purpose": "Insert analytics.recommendations record"
        },
        {
          "name": "get_user_analytics",
          "parameters": ["p_session_id TEXT"],
          "returns": "JSONB",
          "purpose": "Get complete user analytics data (questions, criteria, actions, recommendations)"
        }
      ]
    },
    "analytics_service": {
      "file": "src/lib/analytics.ts",
      "status": "MAJOR UPDATE",
      "priority": "CRITICAL",
      "current_issues": [
        "Calls non-existent RPC functions",
        "Uses old visitor_sessions data model",
        "Missing error handling for database operations"
      ],
      "changes_needed": [
        {
          "function": "trackPageView",
          "action": "UPDATE",
          "old_call": "supabase.rpc('track_page_view', {...})",
          "new_call": "supabase.rpc('ensure_analytics_user', {...})",
          "purpose": "Create/update user record instead of tracking page views"
        },
        {
          "function": "trackCriteriaRanking", 
          "action": "UPDATE",
          "old_call": "supabase.rpc('track_criteria_ranking', {...})",
          "new_call": "supabase.rpc('track_criteria_response', {...})",
          "purpose": "Use new criteria response tracking"
        },
        {
          "function": "trackGuidedRankingAnswer",
          "action": "UPDATE", 
          "old_call": "supabase.rpc('track_guided_ranking_answer', {...})",
          "new_call": "supabase.rpc('track_question_response', {...})",
          "purpose": "Use new question response junction table"
        },
        {
          "function": "trackToolClick",
          "action": "UPDATE",
          "old_call": "supabase.rpc('track_tool_click', {...})",
          "new_call": "supabase.rpc('track_tool_action', {...})",
          "purpose": "Use unified tool action tracking"
        },
        {
          "function": "trackToolImpression",
          "action": "REMOVE",
          "reason": "Consolidated into trackToolAction with action_type: 'impression'"
        },
        {
          "function": "trackReportSent",
          "action": "UPDATE",
          "old_call": "supabase.rpc('track_report_sent', {...})",
          "new_call": "supabase.rpc('track_recommendation_sent', {...})",
          "purpose": "Use new recommendations table"
        },
        {
          "function": "getSessionData",
          "action": "UPDATE",
          "old_call": "supabase.rpc('get_session_data', {...})",
          "new_call": "supabase.rpc('get_user_analytics', {...})",
          "purpose": "Get relational analytics data"
        }
      ],
      "new_functions_to_add": [
        "initializeUser() - Ensure user record exists",
        "getUserQuestionResponses() - Get user's question answers",
        "getUserCriteriaResponses() - Get user's criteria ratings",
        "getUserToolActions() - Get user's tool interactions",
        "getUserRecommendations() - Get user's sent recommendations"
      ]
    },
    "types_definitions": {
      "file": "src/ppm-tool/shared/types/index.ts",
      "status": "ADD NEW TYPES",
      "priority": "HIGH",
      "new_types_needed": [
        {
          "name": "AnalyticsUser",
          "properties": [
            "id: string", "session_id: string", "email?: string",
            "first_name?: string", "last_name?: string",
            "total_time_on_tool: number", "has_manual_ranking: boolean",
            "has_partial_ranking: boolean", "has_full_ranking: boolean", 
            "has_sent_report: boolean", "created_at: string", "updated_at: string"
          ]
        },
        {
          "name": "QuestionResponse",
          "properties": [
            "id: string", "user_id: string", "question_id: string",
            "question_choice_id?: string", "response_text?: string",
            "response_timestamp: string"
          ]
        },
        {
          "name": "CriteriaResponse", 
          "properties": [
            "id: string", "user_id: string", "criteria_id: string",
            "rating: number", "response_timestamp: string"
          ]
        },
        {
          "name": "ToolAction",
          "properties": [
            "id: string", "user_id: string", "tool_id: string",
            "action_type: 'click' | 'view_details' | 'compare' | 'try_free'",
            "position?: number", "match_score?: number", "context?: any",
            "created_at: string"
          ]
        },
        {
          "name": "RecommendationRecord",
          "properties": [
            "id: string", "user_id: string", "recommended_tools: any[]",
            "match_scores: any", "sent_at?: string", "email_sent_to?: string"
          ]
        },
        {
          "name": "UserAnalytics",
          "properties": [
            "user: AnalyticsUser", "question_responses: QuestionResponse[]",
            "criteria_responses: CriteriaResponse[]", "tool_actions: ToolAction[]",
            "recommendations: RecommendationRecord[]"
          ]
        }
      ]
    },
    "component_updates": {
      "guided_ranking_form": {
        "file": "src/ppm-tool/components/forms/GuidedRankingForm.tsx",
        "status": "MAJOR UPDATE",
        "priority": "CRITICAL",
        "current_lines_to_change": [
          "Lines 11-14: Import analytics from '@/lib/analytics'",
          "Lines 989-998: checkAndTrackNewActive tracking calls",
          "Answer handling functions: Need to call analytics.trackQuestionResponse",
          "Component initialization: Load previous answers from analytics instead of localStorage"
        ],
        "specific_changes": [
          {
            "location": "handleAnswer function",
            "current": "Stores answers in component state and localStorage",
            "new": "Store in component state AND call analytics.trackQuestionResponse() for each answer",
            "code_pattern": "analytics.trackQuestionResponse({ questionId, questionChoiceId, responseText })"
          },
          {
            "location": "useEffect initialization",
            "current": "Loads answers from localStorage",
            "new": "Call analytics.getUserQuestionResponses() to load from database",
            "code_pattern": "const userAnalytics = await analytics.getUserAnalytics(sessionId)"
          },
          {
            "location": "Submit handling", 
            "current": "Only tracks to PostHog",
            "new": "Track to both PostHog and ensure all responses are in database",
            "code_pattern": "await analytics.ensureAllResponsesTracked(answers)"
          }
        ]
      },
      "email_report_hook": {
        "file": "src/ppm-tool/shared/hooks/useEmailReport.ts", 
        "status": "UPDATE",
        "priority": "HIGH",
        "lines_to_change": [
          "Lines 185-193: analytics.trackReportSent() call",
          "Lines 87-103: localStorage guided ranking retrieval",
          "Lines 136-157: PostHog + analytics tracking"
        ],
        "specific_changes": [
          {
            "location": "Line 185-193",
            "current": "analytics.trackReportSent() - currently fails",
            "new": "analytics.trackRecommendationSent() - use new function",
            "additional": "Pull user analytics data instead of localStorage"
          },
          {
            "location": "Lines 87-103",
            "current": "localStorage.getItem('guidedRankingAnswers')",
            "new": "analytics.getUserAnalytics() to get question responses",
            "benefit": "Get data from database instead of localStorage"
          }
        ]
      },
      "criteria_slider": {
        "file": "src/ppm-tool/components/ui/slider.tsx",
        "status": "ADD TRACKING", 
        "priority": "HIGH",
        "current": "Only updates component state",
        "new": "Add analytics.trackCriteriaResponse() on value change",
        "integration_point": "onValueChange callback - add analytics call alongside existing logic"
      },
      "tool_section": {
        "file": "src/ppm-tool/features/tools/ToolSection.tsx",
        "status": "ADD TRACKING",
        "priority": "HIGH", 
        "current": "Uses PostHog tracking only",
        "new": "Add analytics.trackToolAction() for all tool interactions",
        "tracking_points": [
          "Try Free clicks", "Add to Compare clicks", "View Details clicks",
          "Include match_score and position data for vendor analytics"
        ]
      },
      "other_components": {
        "files": [
          "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx",
          "src/ppm-tool/features/comparison/ComparisonSection.tsx",
          "src/ppm-tool/components/charts/ComparisonChart.tsx",
          "src/ppm-tool/components/overlays/HowItWorksOverlay.tsx",
          "src/ppm-tool/components/common/EmbeddedPPMToolFlow.tsx"
        ],
        "changes": "Add analytics.trackToolAction() calls alongside existing PostHog tracking",
        "pattern": "Maintain existing PostHog, add Supabase analytics for relational data"
      }
    },
    "posthog_integration_updates": {
      "file": "src/lib/posthog.ts",
      "status": "ENHANCE",
      "priority": "MEDIUM",
      "approach": "Keep existing PostHog tracking, add analytics integration",
      "new_functions_to_add": [
        "enrichWithAnalytics() - Pull user data from analytics for PostHog properties",
        "trackWithBothSystems() - Helper to track to both PostHog and analytics",
        "getAnalyticsSessionData() - Query analytics rollup views for PostHog context"
      ]
    },
    "api_endpoints": {
      "file": "src/app/api/analytics/track/route.ts",
      "status": "UPDATE",
      "priority": "LOW",
      "current": "Just logs events to console",
      "new": "Integrate with analytics service for proper tracking",
      "use_case": "Fallback analytics tracking for JavaScript-disabled users"
    }
  },
  "implementation_order": {
    "step_1": {
      "description": "Create Supabase RPC functions",
      "files": ["supabase/migrations/20251108_analytics_rpc_functions.sql"],
      "validation": "Test RPC functions manually in Supabase dashboard"
    },
    "step_2": {
      "description": "Update analytics service and types",
      "files": ["src/lib/analytics.ts", "src/ppm-tool/shared/types/index.ts"],
      "validation": "Test analytics service functions in browser console"
    },
    "step_3": {
      "description": "Update critical tracking components",
      "files": [
        "src/ppm-tool/components/forms/GuidedRankingForm.tsx",
        "src/ppm-tool/shared/hooks/useEmailReport.ts",
        "src/ppm-tool/components/ui/slider.tsx"
      ],
      "validation": "Test complete user journey from guided ranking to email report"
    },
    "step_4": {
      "description": "Update tool interaction tracking",
      "files": [
        "src/ppm-tool/features/tools/ToolSection.tsx",
        "src/ppm-tool/features/recommendations/components/EnhancedRecommendationSection.tsx",
        "Other tool components"
      ],
      "validation": "Verify tool_action_rollups view shows accurate data"
    },
    "step_5": {
      "description": "Verify rollup views and PostHog integration",
      "files": ["src/lib/posthog.ts", "Dashboard queries"],
      "validation": "Compare PostHog dashboard metrics with Supabase rollup views"
    }
  },
  "testing_checklist": {
    "database_functions": [
      "✓ RPC functions create records in correct tables",
      "✓ Foreign key relationships work properly", 
      "✓ Rollup views return accurate aggregated data",
      "✓ Unique constraints prevent duplicate responses"
    ],
    "analytics_service": [
      "✓ Session ID generation and persistence works",
      "✓ All tracking functions call correct RPC functions",
      "✓ Error handling prevents UI breaks on analytics failures",
      "✓ getUserAnalytics returns complete user data"
    ],
    "user_journey": [
      "✓ Guided ranking saves responses to database",
      "✓ Criteria slider changes tracked to database",
      "✓ Tool clicks tracked with match scores and positions",
      "✓ Email report includes database analytics data",
      "✓ User can resume partial guided ranking from database"
    ],
    "data_integrity": [
      "✓ No duplicate user records created",
      "✓ Junction tables maintain referential integrity",
      "✓ PostHog and Supabase data correlate correctly",
      "✓ Rollup views match raw junction table queries"
    ]
  },
  "rollback_plan": {
    "analytics_service": "Keep current (broken) version as fallback - analytics failures don't break UI",
    "component_changes": "Wrap new analytics calls in try-catch blocks",
    "database_changes": "RPC functions are additive - can be removed without affecting existing data"
  },
  "success_metrics": {
    "technical": [
      "Zero analytics-related errors in browser console",
      "All RPC functions execute successfully", 
      "Rollup views return data within 1 second",
      "PostHog dashboard shows consistent metrics"
    ],
    "business": [
      "Unique user metrics replace page view metrics as discussed in transcript",
      "Tool performance data available for vendor reporting",
      "Complete user journey data captured for AI/vector database preparation",
      "Email reports enhanced with relational analytics data"
    ]
  }
}
