{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-08T22:30:00Z",
  "type": "ARCHITECTURE",
  "metadata": {
    "project": "PPM Tool Finder",
    "maintainer": "Parker Gawne", 
    "mcp_compatible": true,
    "purpose": "Complete data relationship mapping for analytics schema based on mindmap discussion"
  },
  "analytics_schema_structure": {
    "core_tables": {
      "analytics.users": {
        "role": "Central hub - replaces visitor_sessions",
        "primary_key": "id (UUID)",
        "unique_constraints": ["session_id"],
        "key_fields": [
          "session_id - Unique session identifier",
          "email - Links to email reports",
          "total_time_on_tool - New engagement metric",
          "has_manual_ranking, has_partial_ranking, has_full_ranking, has_sent_report - Journey tracking"
        ],
        "relationships": {
          "outgoing": [
            "user_question_responses.user_id -> users.id",
            "user_criteria_responses.user_id -> users.id", 
            "user_tool_actions.user_id -> users.id",
            "recommendations.user_id -> users.id"
          ]
        }
      },
      "analytics.questions": {
        "role": "Dynamic question management - supports changing questions over time",
        "primary_key": "id (UUID)", 
        "key_fields": [
          "question_text - Actual question displayed",
          "question_order - Display sequence (1-12 for guided ranking)",
          "question_type - scale | multiple_choice | text",
          "is_active - Supports A/B testing and iterations"
        ],
        "relationships": {
          "outgoing": [
            "question_choices.question_id -> questions.id",
            "user_question_responses.question_id -> questions.id"
          ]
        },
        "dynamic_capability": "Can add/change questions without losing historical response data"
      },
      "analytics.question_choices": {
        "role": "Answer options - supports dynamic choices",
        "primary_key": "id (UUID)",
        "key_fields": [
          "choice_text - Display text (e.g., '1-5 projects')",
          "choice_value - Stored value (e.g., '1')", 
          "choice_order - Display sequence",
          "is_active - Supports choice modifications"
        ],
        "relationships": {
          "incoming": ["questions.id -> question_choices.question_id"],
          "outgoing": ["user_question_responses.question_choice_id -> question_choices.id"]
        },
        "current_data": {
          "q1_q10": "Scale questions (1-5) with descriptive labels",
          "q11": "Department choices (Engineering, Marketing, Sales, etc.)",
          "q12": "Methodology choices (Agile, Waterfall, Scrum, etc.)"
        }
      }
    },
    "junction_tables": {
      "analytics.user_question_responses": {
        "purpose": "Many-to-many: Users ↔ Questions",
        "constraint": "UNIQUE(user_id, question_id) - One response per question per user",
        "key_fields": [
          "user_id -> analytics.users.id",
          "question_id -> analytics.questions.id", 
          "question_choice_id -> analytics.question_choices.id",
          "response_text - For text responses",
          "response_timestamp - When answered"
        ],
        "enables": [
          "Dynamic question changes without data loss",
          "A/B testing different question phrasings", 
          "Historical analysis of response patterns"
        ],
        "rollup_to": [
          "questions -> total_responses, response_count",
          "question_choices -> unique_selections, selection_percentage",
          "users -> questions_answered"
        ]
      },
      "analytics.user_criteria_responses": {
        "purpose": "Many-to-many: Users ↔ Criteria (from public schema)",
        "constraint": "UNIQUE(user_id, criteria_id) - One rating per criteria per user",
        "key_fields": [
          "user_id -> analytics.users.id",
          "criteria_id -> public.criteria.id",
          "rating - INTEGER 1-5 scale",
          "response_timestamp - When rated"
        ],
        "enables": [
          "Adding new criteria without affecting historical data",
          "Criteria importance analysis",
          "Match score calculation transparency"
        ],
        "rollup_to": [
          "public.criteria -> avg_rating, rating distribution counts",
          "users -> criteria_rated"
        ]
      },
      "analytics.user_tool_actions": {
        "purpose": "Many-to-many: Users ↔ Tools (monetization tracking)",
        "constraint": "NO unique constraint - Multiple actions per user-tool pair allowed",
        "key_fields": [
          "user_id -> analytics.users.id",
          "tool_id -> public.tools.id",
          "action_type - click | view_details | compare | try_free",
          "position - Position in results when action occurred",
          "match_score - Match score at time of action",
          "context - Additional data as JSONB"
        ],
        "action_types": {
          "click": "Basic tool interaction",
          "view_details": "Opened detailed information", 
          "compare": "Added to comparison view",
          "try_free": "Monetization event - clicked try free button"
        },
        "enables": [
          "Tool performance analysis",
          "User engagement patterns", 
          "Monetization tracking for vendor revenue",
          "A/B testing tool positioning"
        ],
        "rollup_to": [
          "public.tools -> unique/total counts per action type, avg_match_score",
          "users -> tools_interacted_with, total_tool_actions"
        ]
      }
    },
    "supporting_tables": {
      "analytics.recommendations": {
        "purpose": "Track email reports sent to users",
        "primary_key": "id (UUID)",
        "relationships": {
          "incoming": ["users.id -> recommendations.user_id"]
        },
        "key_fields": [
          "recommended_tools - JSONB array of tool recommendations",
          "match_scores - JSONB object of scores",
          "sent_at - When email was sent",
          "email_sent_to - Email address used"
        ]
      }
    }
  },
  "data_flow_patterns": {
    "user_journey_tracking": {
      "entry_point": "analytics.users table created on first visit",
      "guided_ranking_flow": [
        "1. User answers questions -> user_question_responses records created",
        "2. User rates criteria -> user_criteria_responses records created", 
        "3. User interacts with tools -> user_tool_actions records created",
        "4. User requests report -> recommendations record created"
      ],
      "foreign_key_chain": "users -> junction_tables -> rollup_views"
    },
    "rollup_aggregation": {
      "real_time_views": [
        "tool_action_rollups - Aggregates user_tool_actions by tool",
        "question_response_rollups - Aggregates user_question_responses by question",
        "question_choice_rollups - Aggregates selections by choice",
        "criteria_response_rollups - Aggregates ratings by criteria", 
        "user_activity_rollups - Aggregates all user interactions"
      ],
      "benefit": "No need to run complex JOIN queries - views pre-aggregate data"
    }
  },
  "foreign_key_relationships": {
    "within_analytics_schema": [
      "question_choices.question_id -> questions.id",
      "user_question_responses.user_id -> users.id",
      "user_question_responses.question_id -> questions.id",
      "user_question_responses.question_choice_id -> question_choices.id",
      "user_criteria_responses.user_id -> users.id",
      "user_tool_actions.user_id -> users.id",
      "recommendations.user_id -> users.id"
    ],
    "cross_schema_references": [
      "user_criteria_responses.criteria_id -> public.criteria.id",
      "user_tool_actions.tool_id -> public.tools.id"
    ],
    "cascade_behavior": "ON DELETE CASCADE - Removing a user removes all their responses"
  },
  "unique_constraints": {
    "business_rules_enforced": [
      "users.session_id - One user per session",
      "user_question_responses(user_id, question_id) - One answer per question per user",
      "user_criteria_responses(user_id, criteria_id) - One rating per criteria per user"
    ],
    "no_constraints": [
      "user_tool_actions - Users can perform multiple actions on same tool"
    ]
  },
  "indexing_strategy": {
    "primary_keys": "All tables have UUID primary keys for fast lookups",
    "foreign_key_indexes": "Automatic indexes on all foreign key columns",
    "composite_indexes": [
      "user_question_responses(user_id, question_id, response_timestamp)",
      "user_tool_actions(user_id, tool_id, action_type, created_at)"
    ],
    "specialized_indexes": [
      "users.session_id - Unique index for session lookups",
      "users.email - Index for email-based queries",
      "questions(is_active, question_order) - Active question ordering",
      "user_tool_actions.action_type - Action type filtering"
    ]
  },
  "posthog_replacement_queries": {
    "unique_viewers": {
      "old": "PostHog distinct_id counting with duplication issues",
      "new": "SELECT COUNT(DISTINCT session_id) FROM analytics.users",
      "benefit": "Accurate unique user counting"
    },
    "conversion_funnel": {
      "stages": [
        "visited: COUNT(*) FROM analytics.users",
        "started_ranking: COUNT(*) FROM analytics.users WHERE has_partial_ranking = true",  
        "completed_ranking: COUNT(*) FROM analytics.users WHERE has_full_ranking = true",
        "sent_report: COUNT(*) FROM analytics.users WHERE has_sent_report = true"
      ]
    },
    "tool_performance": {
      "old": "Complex PostHog event aggregations",
      "new": "SELECT * FROM analytics.tool_action_rollups",
      "benefit": "Pre-aggregated metrics for vendor reporting"
    }
  },
  "vector_database_readiness": {
    "embedding_candidates": {
      "user_preferences": "Concatenated responses from user_question_responses and user_criteria_responses",
      "tool_interactions": "User behavior patterns from user_tool_actions",
      "question_effectiveness": "Response patterns from rollup views"
    },
    "llm_query_capabilities": [
      "Match score explanations using user's specific responses",
      "Tool recommendations based on similar user profiles",
      "Analytics insights for vendor dashboards"
    ]
  },
  "migration_verification": {
    "data_integrity_confirmed": [
      "All visitor_sessions data migrated to users table",
      "guided_ranking_answers JSON parsed into user_question_responses",
      "criteria_rankings JSON parsed into user_criteria_responses", 
      "Email report tracking preserved in recommendations"
    ],
    "foreign_keys_verified": "All relationships properly established with CASCADE constraints",
    "rollup_views_tested": "Aggregation queries return expected results"
  }
}
