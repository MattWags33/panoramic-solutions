{
  "schema_version": "1.0.0",
  "last_updated": "2025-11-08T23:00:00Z",
  "type": "MIGRATION",
  "metadata": {
    "project": "PPM Tool Finder",
    "maintainer": "Parker Gawne",
    "mcp_compatible": true,
    "purpose": "Complete frontend code changes required for new analytics schema"
  },
  "current_state_analysis": {
    "analytics_service": {
      "file": "src/lib/analytics.ts",
      "status": "CALLS NON-EXISTENT RPC FUNCTIONS",
      "issues": [
        "track_page_view() - RPC function doesn't exist",
        "track_criteria_ranking() - RPC function doesn't exist", 
        "track_guided_ranking_answer() - RPC function doesn't exist",
        "track_tool_click() - RPC function doesn't exist",
        "track_tool_impression() - RPC function doesn't exist",
        "track_report_sent() - RPC function doesn't exist",
        "get_session_data() - RPC function doesn't exist"
      ],
      "data_model": "Assumes old visitor_sessions table with JSON fields"
    },
    "posthog_integration": {
      "file": "src/lib/posthog.ts", 
      "status": "WORKING BUT SEPARATE",
      "current_tracking": [
        "New_Visitor", "New_Active", "New_Manual_Ranking", 
        "New_Partial_Ranking", "New_Full_Ranking_Submittal", 
        "New_Report_Sent", "Tool_Try_Free_Click", "Tool_Add_To_Compare_Click", 
        "Tool_View_Details_Click"
      ]
    },
    "components_using_analytics": [
      "GuidedRankingForm.tsx - guided ranking tracking",
      "useEmailReport.ts - report sent tracking", 
      "Various tool components - tool click tracking",
      "Slider components - criteria ranking tracking"
    ],
    "data_storage": "localStorage + PostHog + failed Supabase calls"
  },
  "migration_plan": {
    "phase_1_supabase_functions": {
      "priority": "HIGH",
      "description": "Create RPC functions for new relational schema",
      "files_to_create": [
        {
          "file": "supabase/migrations/20251108_analytics_rpc_functions.sql",
          "purpose": "Create RPC functions matching current analytics.ts interface but using new relational tables",
          "functions_needed": [
            "track_user_session() - Create/update analytics.users record",
            "track_question_response() - Insert into user_question_responses junction table",
            "track_criteria_response() - Insert into user_criteria_responses junction table", 
            "track_tool_action() - Insert into user_tool_actions junction table",
            "track_recommendation_sent() - Insert into analytics.recommendations table",
            "get_user_analytics() - Get complete user analytics data"
          ]
        }
      ]
    },
    "phase_2_analytics_service": {
      "priority": "HIGH",
      "description": "Update analytics service to use new RPC functions and data model",
      "files_to_update": [
        {
          "file": "src/lib/analytics.ts",
          "changes": [
            "Replace track_page_view() with track_user_session()",
            "Replace track_criteria_ranking() with track_criteria_response()",
            "Replace track_guided_ranking_answer() with track_question_response()", 
            "Replace track_tool_click() with track_tool_action()",
            "Remove track_tool_impression() - consolidated into track_tool_action()",
            "Replace track_report_sent() with track_recommendation_sent()",
            "Update getAnalyticsSessionId() to work with analytics.users table",
            "Add functions for new relational data queries"
          ],
          "new_functions_needed": [
            "ensureUserRecord() - Create/update user in analytics.users",
            "trackQuestionResponse() - Track guided ranking answers",
            "trackCriteriaResponse() - Track criteria ratings",
            "trackToolAction() - Track all tool interactions",
            "getUserAnalytics() - Get user's complete analytics data"
          ]
        }
      ]
    },
    "phase_3_types_update": {
      "priority": "MEDIUM", 
      "description": "Add TypeScript types for new analytics schema",
      "files_to_update": [
        {
          "file": "src/ppm-tool/shared/types/index.ts",
          "changes": [
            "Add AnalyticsUser interface matching analytics.users table",
            "Add QuestionResponse interface matching user_question_responses",
            "Add CriteriaResponse interface matching user_criteria_responses",
            "Add ToolAction interface matching user_tool_actions",
            "Add Recommendation interface matching analytics.recommendations",
            "Add AnalyticsSession interface for complete session data",
            "Update existing interfaces to work with new analytics"
          ]
        }
      ]
    },
    "phase_4_component_updates": {
      "priority": "HIGH",
      "description": "Update components to use new analytics tracking",
      "files_to_update": [
        {
          "file": "src/ppm-tool/components/forms/GuidedRankingForm.tsx",
          "changes": [
            "Update question answer tracking to use analytics.trackQuestionResponse()",
            "Maintain PostHog tracking for comparison",
            "Use new relational approach instead of localStorage answers",
            "Track each question response individually to junction table"
          ],
          "lines_affected": ["Lines 989-998 (checkAndTrackNewActive calls)", "Answer handling logic throughout"]
        },
        {
          "file": "src/ppm-tool/shared/hooks/useEmailReport.ts",
          "changes": [
            "Update analytics.trackReportSent() call (lines 185-193)",
            "Replace localStorage guided ranking retrieval with database query",
            "Use new recommendation tracking instead of visitor_sessions approach",
            "Maintain PostHog integration alongside new analytics"
          ]
        },
        {
          "file": "src/ppm-tool/components/ui/slider.tsx",
          "changes": [
            "Add criteria response tracking to analytics.trackCriteriaResponse()",
            "Track each criteria rating change to user_criteria_responses table",
            "Maintain existing PostHog manual ranking tracking"
          ]
        }
      ]
    },
    "phase_5_tool_tracking": {
      "priority": "HIGH",
      "description": "Update tool interaction tracking across all tool components", 
      "files_to_search_and_update": [
        {
          "search_pattern": "trackToolTryFreeClick|trackToolAddToCompareClick|trackToolViewDetailsClick",
          "update_approach": "Add analytics.trackToolAction() calls alongside existing PostHog tracking",
          "expected_files": [
            "Tool card components",
            "Tool section components", 
            "Comparison components",
            "Recommendation components"
          ]
        }
      ]
    },
    "phase_6_posthog_integration": {
      "priority": "MEDIUM",
      "description": "Maintain PostHog but integrate with new analytics data",
      "files_to_update": [
        {
          "file": "src/lib/posthog.ts",
          "changes": [
            "Keep existing PostHog tracking (don't break current dashboard)",
            "Add helper functions to pull data from new analytics schema",
            "Create hybrid tracking approach - PostHog for events, Supabase for relational data",
            "Add functions to query rollup views for PostHog property enrichment"
          ]
        },
        {
          "file": "src/hooks/usePostHog.ts",
          "changes": [
            "Add analytics integration functions",
            "Create unified tracking interface that hits both PostHog and analytics",
            "Add functions to pull user analytics data for PostHog context"
          ]
        }
      ]
    }
  },
  "specific_component_changes": {
    "guided_ranking_form": {
      "current_approach": "Stores answers in localStorage, tracks to PostHog, attempts failed Supabase tracking",
      "new_approach": "Store each answer in user_question_responses junction table, maintain PostHog, query from database",
      "key_changes": [
        "Replace localStorage answer storage with database queries",
        "Track each question response individually via analytics.trackQuestionResponse()",
        "Use analytics.getUserAnalytics() to reload previous answers",
        "Maintain existing PostHog tracking for dashboard compatibility"
      ]
    },
    "criteria_sliders": {
      "current_approach": "Updates Criterion objects, tracks manual ranking to PostHog",
      "new_approach": "Store each rating in user_criteria_responses table, maintain PostHog",
      "key_changes": [
        "Add analytics.trackCriteriaResponse() on each slider change",
        "Query previous ratings from user_criteria_responses on load",
        "Use rollup views to get criteria effectiveness data"
      ]
    },
    "tool_interactions": {
      "current_approach": "PostHog tracking only for try_free, compare, view_details actions",
      "new_approach": "Track to both PostHog and user_tool_actions table for monetization analytics",
      "key_changes": [
        "Add analytics.trackToolAction() for every tool interaction",
        "Include match_score and position data for vendor reporting",
        "Use tool_action_rollups view for vendor dashboards"
      ]
    },
    "email_reporting": {
      "current_approach": "PostHog tracking + attempted analytics.trackReportSent() that fails",
      "new_approach": "PostHog + working analytics.trackRecommendationSent() to recommendations table",
      "key_changes": [
        "Fix analytics.trackReportSent() to use new schema",
        "Store complete recommendation data in analytics.recommendations",
        "Link user email to analytics.users table",
        "Query user's complete analytics history for report personalization"
      ]
    }
  },
  "data_migration_considerations": {
    "session_continuity": {
      "issue": "Users mid-session when migration deploys",
      "solution": "Keep existing localStorage session_id logic, create analytics.users record on first new tracking call"
    },
    "historical_data": {
      "issue": "Existing PostHog data vs new Supabase data",
      "solution": "Maintain parallel tracking during transition, PostHog for dashboard continuity, Supabase for new relational insights"
    },
    "question_responses": {
      "issue": "Existing guided ranking answers in localStorage",
      "solution": "Create migration function to import localStorage answers into user_question_responses table on next visit"
    }
  },
  "testing_approach": {
    "unit_tests": [
      "Test new analytics RPC functions",
      "Test analytics service function updates",
      "Test component tracking integration"
    ],
    "integration_tests": [
      "Test complete user journey tracking",
      "Test PostHog + Supabase dual tracking",
      "Test rollup view data accuracy"
    ],
    "user_acceptance_tests": [
      "Verify no UI behavior changes",
      "Verify email reports still work",
      "Verify guided ranking still works",
      "Test analytics dashboard shows accurate data"
    ]
  },
  "rollout_strategy": {
    "step_1": "Deploy Supabase RPC functions and new analytics service",
    "step_2": "Update components to use new analytics (parallel tracking)",
    "step_3": "Verify data accuracy in new rollup views", 
    "step_4": "Update PostHog dashboards to use unique user metrics",
    "step_5": "Remove old visitor_sessions dependencies"
  },
  "api_endpoint_updates": {
    "files_to_update": [
      {
        "file": "src/app/api/analytics/track/route.ts",
        "changes": [
          "Currently just logs events - update to use new analytics service",
          "Add proper error handling and response codes",
          "Support new analytics schema tracking"
        ]
      }
    ]
  },
  "dashboard_updates": {
    "posthog_replacements": {
      "description": "Update PostHog queries to use unique user metrics as discussed in transcript",
      "changes": [
        "Replace page view counts with unique user counts from analytics.users",
        "Use conversion funnel from analytics.users journey tracking", 
        "Pull tool performance data from tool_action_rollups view",
        "Show question effectiveness from question_response_rollups"
      ]
    }
  }
}